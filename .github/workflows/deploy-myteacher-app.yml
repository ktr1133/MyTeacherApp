###############################################################################
# MyTeacher App Ëá™Âãï„Éá„Éó„É≠„Ç§„ÉØ„Éº„ÇØ„Éï„É≠„Éº
#
# „Éà„É™„Ç¨„Éº:
#   - main „Éñ„É©„É≥„ÉÅ„Å∏„ÅÆpush (app/ÈÖç‰∏ã„ÅÆÂ§âÊõ¥ÊôÇ)
#   - ÊâãÂãï„Éà„É™„Ç¨„Éº
#
# „Çπ„ÉÜ„ÉÉ„Éó:
#   1. Docker„Ç§„É°„Éº„Ç∏„Éì„É´„Éâ
#   2. ECR„Éó„ÉÉ„Ç∑„É•
#   3. ECS„Çø„Çπ„ÇØÂÆöÁæ©Êõ¥Êñ∞
#   4. ECS„Çµ„Éº„Éì„ÇπÊõ¥Êñ∞Ôºà„É≠„Éº„É™„É≥„Ç∞„Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÔºâ
###############################################################################

name: Deploy MyTeacher App

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'config/**'
      - 'database/**'
      - 'resources/**'
      - 'routes/**'
      - 'composer.json'
      - 'composer.lock'
      - '.github/workflows/deploy-myteacher-app.yml'
  workflow_dispatch:  # ÊâãÂãï„Éà„É™„Ç¨„Éº
    inputs:
      skip_build:
        description: 'Skip Docker build (use existing image)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: myteacher-production
  ECS_CLUSTER: myteacher-production-cluster
  ECS_SERVICE: myteacher-production-app-service
  ECS_TASK_DEFINITION: myteacher-production-app

jobs:
  deploy:
    name: Build and Deploy to ECS
    runs-on: ubuntu-latest
    
    steps:
      #########################################################################
      # 1. „É™„Éù„Ç∏„Éà„É™„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      #########################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      #########################################################################
      # 2. AWSË™çË®º
      #########################################################################
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      #########################################################################
      # 3. ECR„É≠„Ç∞„Ç§„É≥
      #########################################################################
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      #########################################################################
      # 4. Docker„Ç§„É°„Éº„Ç∏„Éì„É´„Éâ & „Éó„ÉÉ„Ç∑„É•
      #########################################################################
      - name: Build and push Docker image
        if: ${{ !inputs.skip_build }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Docker„Ç§„É°„Éº„Ç∏„Éì„É´„Éâ
          docker build \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            --file docker/Dockerfile \
            .
          
          # ECR„Å´„Éó„ÉÉ„Ç∑„É•
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "Pushed image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      #########################################################################
      # 5. ECS„Çø„Çπ„ÇØÂÆöÁæ©ÂèñÂæó
      #########################################################################
      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition $ECS_TASK_DEFINITION \
            --query taskDefinition \
            > task-definition.json
          
          # ‰∏çË¶Å„Å™„Éï„Ç£„Éº„É´„Éâ„ÇíÂâäÈô§
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            task-definition.json > task-definition-clean.json

      #########################################################################
      # 6. Êñ∞„Åó„ÅÑ„Ç§„É°„Éº„Ç∏„Åß„Çø„Çπ„ÇØÂÆöÁæ©Êõ¥Êñ∞
      #########################################################################
      - name: Update task definition with new image
        if: ${{ !inputs.skip_build }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # „Ç≥„É≥„ÉÜ„Éä„Ç§„É°„Éº„Ç∏„ÇíÊõ¥Êñ∞
          jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" \
            '.containerDefinitions[0].image = $IMAGE' \
            task-definition-clean.json > task-definition-new.json

      #########################################################################
      # 7. ECS„Çø„Çπ„ÇØÂÆöÁæ©ÁôªÈå≤
      #########################################################################
      - name: Register new task definition
        if: ${{ !inputs.skip_build }}
        id: task-def
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-definition-new.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "task-definition-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "Registered task definition: $TASK_DEF_ARN"

      #########################################################################
      # 8. ECS„Çµ„Éº„Éì„ÇπÊõ¥Êñ∞Ôºà„É≠„Éº„É™„É≥„Ç∞„Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÔºâ
      #########################################################################
      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --force-new-deployment \
            --query 'service.{ServiceName:serviceName,Status:status,DesiredCount:desiredCount}'
          
          echo "‚úÖ ECS service update initiated"

      #########################################################################
      # 9. „Éá„Éó„É≠„Ç§ÂÆå‰∫ÜÂæÖÊ©ü
      #########################################################################
      - name: Wait for deployment to complete
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          aws ecs wait services-stable \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE
          
          echo "‚úÖ Deployment completed successfully"

      #########################################################################
      # 10. „Éá„Éó„É≠„Ç§ÊàêÂäüÈÄöÁü•
      #########################################################################
      - name: Deployment success notification
        if: success()
        run: |
          echo "üéâ MyTeacher App deployed successfully!"
          echo "Cluster: $ECS_CLUSTER"
          echo "Service: $ECS_SERVICE"
          echo "Commit: ${{ github.sha }}"
