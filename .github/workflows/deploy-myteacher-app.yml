###############################################################################
# MyTeacher App è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ãƒˆãƒªã‚¬ãƒ¼:
#   - main ãƒ–ãƒ©ãƒ³ãƒã¸ã®push (app/é…ä¸‹ã®å¤‰æ›´æ™‚)
#   - æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
#
# ã‚¹ãƒ†ãƒƒãƒ—:
#   1. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
#   2. ECRãƒ—ãƒƒã‚·ãƒ¥
#   3. ECSã‚¿ã‚¹ã‚¯å®šç¾©æ›´æ–°
#   4. ECSã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°ï¼ˆãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼‰
###############################################################################

name: Deploy MyTeacher App

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'config/**'
      - 'database/**'
      - 'resources/**'
      - 'routes/**'
      - 'public/**'
      - 'composer.json'
      - 'composer.lock'
      - '.github/workflows/deploy-myteacher-app.yml'
  workflow_dispatch:  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
    inputs:
      skip_build:
        description: 'Skip Docker build (use existing image)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: myteacher-production
  ECS_CLUSTER: myteacher-production-cluster
  ECS_SERVICE: myteacher-production-app-service
  ECS_TASK_DEFINITION: myteacher-production-app

jobs:
  deploy:
    name: Build and Deploy to ECS
    runs-on: ubuntu-latest
    
    steps:
      #########################################################################
      # 1. ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      #########################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      #########################################################################
      # 2. AWSèªè¨¼
      #########################################################################
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      #########################################################################
      # 3. ECRãƒ­ã‚°ã‚¤ãƒ³
      #########################################################################
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      #########################################################################
      # 4. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ & ãƒ—ãƒƒã‚·ãƒ¥
      #########################################################################
      - name: Build and push Docker image
        if: ${{ !inputs.skip_build }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
          docker build \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            --file docker/Dockerfile \
            .
          
          # ECRã«ãƒ—ãƒƒã‚·ãƒ¥
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "Pushed image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      #########################################################################
      # 5. ECSã‚¿ã‚¹ã‚¯å®šç¾©å–å¾—
      #########################################################################
      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition $ECS_TASK_DEFINITION \
            --query taskDefinition \
            > task-definition.json
          
          # ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            task-definition.json > task-definition-clean.json

      #########################################################################
      # 6. æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã‚¿ã‚¹ã‚¯å®šç¾©æ›´æ–°
      #########################################################################
      - name: Update task definition with new image
        if: ${{ !inputs.skip_build }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
          APP_KEY: ${{ secrets.APP_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          # ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ›´æ–°
          jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" \
            '.containerDefinitions[0].image = $IMAGE' \
            task-definition-clean.json > task-definition-tmp.json
          
          # APP_KEYç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®å€¤ã‚’å‰Šé™¤ã—ã¦è¿½åŠ ï¼‰
          jq --arg APP_KEY "$APP_KEY" \
            '.containerDefinitions[0].environment = 
              [.containerDefinitions[0].environment[] | select(.name != "APP_KEY")] + 
              [{name: "APP_KEY", value: $APP_KEY}]' \
            task-definition-tmp.json > task-definition-tmp2.json
          
          # DB_PASSWORDç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®å€¤ã‚’å‰Šé™¤ã—ã¦è¿½åŠ ï¼‰
          jq --arg DB_PASSWORD "$DB_PASSWORD" \
            '.containerDefinitions[0].environment = 
              [.containerDefinitions[0].environment[] | select(.name != "DB_PASSWORD")] + 
              [{name: "DB_PASSWORD", value: $DB_PASSWORD}]' \
            task-definition-tmp2.json > task-definition-tmp3.json
          
          # LOG_CHANNELç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼ˆstderr: CloudWatch Logsã«ç›´æ¥å‡ºåŠ›ï¼‰
          jq '.containerDefinitions[0].environment = 
              [.containerDefinitions[0].environment[] | select(.name != "LOG_CHANNEL")] + 
              [{name: "LOG_CHANNEL", value: "stderr"}]' \
            task-definition-tmp3.json > task-definition-tmp4.json
          
          # ENTRYPOINT/CMDã‚’æ˜ç¤ºçš„ã«è¨­å®šï¼ˆECSãŒDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ENTRYPOINTã‚’ç„¡è¦–ã™ã‚‹å•é¡Œã®å›é¿ï¼‰
          # ãƒ‡ãƒãƒƒã‚°: startup-debug.shãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‹ç¢ºèª
          jq '.containerDefinitions[0].entryPoint = ["/usr/local/bin/startup-debug.sh"] |
              .containerDefinitions[0].command = ["apache2-foreground"]' \
            task-definition-tmp4.json > task-definition-new.json
          
          echo "=== Task Definition Preview ==="
          jq '.containerDefinitions[0] | {name, image, entryPoint, command}' task-definition-new.json

      #########################################################################
      # 7. ECSã‚¿ã‚¹ã‚¯å®šç¾©ç™»éŒ²
      #########################################################################
      - name: Register new task definition
        if: ${{ !inputs.skip_build }}
        id: task-def
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-definition-new.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "task-definition-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "Registered task definition: $TASK_DEF_ARN"

      #########################################################################
      # 8. ECSã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°ï¼ˆãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼‰
      #########################################################################
      - name: Update ECS service
        run: |
          # æ–°ã—ã„Task Definitionã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°
          TASK_DEF_ARN="${{ steps.task-def.outputs.task-definition-arn }}"
          if [ -z "$TASK_DEF_ARN" ]; then
            echo "âŒ ERROR: Task Definition ARN not found"
            exit 1
          fi
          
          echo "ğŸ“‹ Updating service with Task Definition: $TASK_DEF_ARN"
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --task-definition "$TASK_DEF_ARN" \
            --force-new-deployment \
            --query 'service.{ServiceName:serviceName,Status:status,DesiredCount:desiredCount,TaskDefinition:taskDefinition}'
          
          echo "âœ… ECS service update initiated"

      #########################################################################
      # 9. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿ
      #########################################################################
      - name: Wait for deployment to complete
        run: |
          echo "â³ Waiting for deployment to complete..."
          aws ecs wait services-stable \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE
          
          echo "âœ… Deployment completed successfully"

      #########################################################################
      # 10. ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
      #########################################################################
      - name: Deployment success notification
        if: success()
        run: |
          echo "ğŸ‰ MyTeacher App deployed successfully!"
          echo "Cluster: $ECS_CLUSTER"
          echo "Service: $ECS_SERVICE"
          echo "Commit: ${{ github.sha }}"
