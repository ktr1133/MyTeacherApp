###############################################################################
# MyTeacher App è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ãƒˆãƒªã‚¬ãƒ¼:
#   - main ãƒ–ãƒ©ãƒ³ãƒã¸ã®push (app/é…ä¸‹ã®å¤‰æ›´æ™‚)
#   - æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ (workflow_dispatch)
#
# ã‚¹ãƒ†ãƒƒãƒ—:
#   1. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
#   2. ECRãƒ—ãƒƒã‚·ãƒ¥
#   3. ECSã‚¿ã‚¹ã‚¯å®šç¾©æ›´æ–°
#   4. ECSã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°ï¼ˆãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼‰
###############################################################################

name: Deploy MyTeacher App

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'config/**'
      - 'database/**'
      - 'resources/**'
      - 'routes/**'
      - 'public/**'
      - 'docker/**'
      - 'composer.json'
      - 'composer.lock'
      - '.github/workflows/deploy-myteacher-app.yml'
  workflow_dispatch:  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
    inputs:
      skip_build:
        description: 'Skip Docker build (use existing image)'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'Skip tests (for emergency deployments)'
        required: false
        type: boolean
        default: false
      skip_migrations:
        description: 'Skip database migrations (use with caution)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: myteacher-production
  ECS_CLUSTER: myteacher-production-cluster
  ECS_SERVICE: myteacher-production-app-service
  ECS_TASK_DEFINITION: myteacher-production-app

jobs:
  deploy:
    name: Build and Deploy to ECS
    runs-on: ubuntu-latest
    
    # ClamAV Service Containerï¼ˆã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ãƒ†ã‚¹ãƒˆç”¨ï¼‰
    services:
      clamav:
        image: clamav/clamav:1.4
        ports:
          - 3310:3310
        options: >-
          --health-cmd "clamdscan --ping 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    
    steps:
      #########################################################################
      # 1. ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      #########################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      #########################################################################
      # 2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå¿…é ˆ: ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ–­ï¼‰
      #########################################################################
      - name: Run Tests
        if: ${{ !inputs.skip_tests }}
        # continue-on-error: true ã‚’å‰Šé™¤ã—ã¦ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ–­
        env:
          # ClamAVè¨­å®šï¼ˆGitHub Actions Service Containerç”¨ï¼‰
          CLAMAV_USE_DAEMON: true
          CLAMAV_DAEMON_HOST: localhost
          CLAMAV_DAEMON_PORT: 3310
          # OpenAI APIè¨­å®šï¼ˆãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ - Http::fake()ã§ãƒ¢ãƒƒã‚¯æ¸ˆã¿ï¼‰
          OPENAI_API_KEY: sk-test-dummy-key-for-ci-environment
        run: |
          echo "ğŸ§ª Running tests with SQLite in-memory database..."
          
          # Composerã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          composer install --no-interaction --prefer-dist --optimize-autoloader
          
          # .envãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
          cp .env.example .env
          
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’arrayã«è¨­å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä¸è¦ï¼‰
          sed -i 's/^CACHE_STORE=.*/CACHE_STORE=array/' .env
          sed -i 's/^SESSION_DRIVER=.*/SESSION_DRIVER=array/' .env
          sed -i 's/^QUEUE_CONNECTION=.*/QUEUE_CONNECTION=sync/' .env
          
          # APP_KEYã‚’ç”Ÿæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
          php artisan key:generate --ansi
          
          # è¨­å®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒã§æ­£ã—ã„è¨­å®šã‚’èª­ã¿è¾¼ã‚€ï¼‰
          php artisan config:clear
          
          # ClamAVã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šç¢ºèª
          echo "ğŸ” Checking ClamAV service availability..."
          timeout 30 bash -c 'until nc -z localhost 3310; do sleep 1; done' || {
            echo "âš ï¸ ClamAV service not ready after 30s, tests may fail"
          }
          echo "âœ… ClamAV service is ready"
          
          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆphpunit.xmlã§SQLiteè¨­å®šæ¸ˆã¿ï¼‰
        # å¤±æ•—æ™‚ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ–­ï¼ˆcontinue-on-errorå‰Šé™¤ã«ã‚ˆã‚Šå®Ÿç¾ï¼‰
        # è©³ç´°ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆä¸€æ™‚çš„ï¼‰
        php artisan test --parallel --stop-on-failure --display-errors || {
          echo "âš ï¸ ãƒ†ã‚¹ãƒˆå¤±æ•— - Laravelãƒ­ã‚°ã‚’ç¢ºèª"
          # æ—¥æ¬¡ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å½¢å¼ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          LOG_FILE=$(ls -t storage/logs/laravel-*.log 2>/dev/null | head -1)
          if [ -n "$LOG_FILE" ]; then
            echo "=== Laravel Log: $LOG_FILE (last 100 lines) ==="
            tail -100 "$LOG_FILE"
          else
            echo "âš ï¸ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          exit 1
        }          echo "âœ… All tests passed successfully"

      #########################################################################
      # 3. ã‚¢ã‚»ãƒƒãƒˆãƒ“ãƒ«ãƒ‰æ¤œè¨¼
      #########################################################################
      - name: Verify Asset Build
        run: |
          echo "ğŸ“¦ Verifying asset build..."
          
          # package.jsonã®å­˜åœ¨ç¢ºèª
          if [ ! -f "package.json" ]; then
            echo "âš ï¸ package.json not found, skipping asset verification"
            exit 0
          fi
          
          # manifest.jsonã®å­˜åœ¨ç¢ºèªï¼ˆViteãƒ“ãƒ«ãƒ‰æˆæœç‰©ï¼‰
          if [ ! -f "public/build/manifest.json" ]; then
            echo "âŒ Asset build manifest not found"
            echo "â„¹ï¸ Note: Assets should be built during Docker image creation"
            exit 1
          fi
          
          echo "âœ… Asset build verified"

      #########################################################################
      # 4. AWSèªè¨¼
      #########################################################################
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      #########################################################################
      # 5. ECRãƒ­ã‚°ã‚¤ãƒ³
      #########################################################################
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      #########################################################################
      # 6. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ & ãƒ—ãƒƒã‚·ãƒ¥
      #########################################################################
      - name: Build and push Docker image
        if: ${{ !inputs.skip_build }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
          docker build \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            --file docker/Dockerfile \
            .
          
          # ECRã«ãƒ—ãƒƒã‚·ãƒ¥
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "Pushed image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      #########################################################################
      # 7. ECSã‚¿ã‚¹ã‚¯å®šç¾©å–å¾—
      #########################################################################
      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition $ECS_TASK_DEFINITION \
            --query taskDefinition \
            > task-definition.json
          
          # ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            task-definition.json > task-definition-clean.json

      #########################################################################
      # 8. æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã‚¿ã‚¹ã‚¯å®šç¾©æ›´æ–°
      #########################################################################
      - name: Update task definition with new image
        if: ${{ !inputs.skip_build }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
          APP_KEY: ${{ secrets.APP_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          # ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ›´æ–°
          jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" \
            '.containerDefinitions[0].image = $IMAGE' \
            task-definition-clean.json > task-definition-tmp.json
          
          # APP_KEYç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®å€¤ã‚’å‰Šé™¤ã—ã¦è¿½åŠ ï¼‰
          jq --arg APP_KEY "$APP_KEY" \
            '.containerDefinitions[0].environment = 
              [.containerDefinitions[0].environment[] | select(.name != "APP_KEY")] + 
              [{name: "APP_KEY", value: $APP_KEY}]' \
            task-definition-tmp.json > task-definition-tmp2.json
          
          # DB_PASSWORDç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®å€¤ã‚’å‰Šé™¤ã—ã¦è¿½åŠ ï¼‰
          jq --arg DB_PASSWORD "$DB_PASSWORD" \
            '.containerDefinitions[0].environment = 
              [.containerDefinitions[0].environment[] | select(.name != "DB_PASSWORD")] + 
              [{name: "DB_PASSWORD", value: $DB_PASSWORD}]' \
            task-definition-tmp2.json > task-definition-tmp3.json
          
          # LOG_CHANNELç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼ˆstderr: CloudWatch Logsã«ç›´æ¥å‡ºåŠ›ï¼‰
          jq '.containerDefinitions[0].environment = 
              [.containerDefinitions[0].environment[] | select(.name != "LOG_CHANNEL")] + 
              [{name: "LOG_CHANNEL", value: "stderr"}]' \
            task-definition-tmp3.json > task-definition-tmp4.json
          
          # ENTRYPOINT/CMDã‚’æ˜ç¤ºçš„ã«è¨­å®šï¼ˆECSãŒDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ENTRYPOINTã‚’ç„¡è¦–ã™ã‚‹å•é¡Œã®å›é¿ï¼‰
          # ãƒ‡ãƒãƒƒã‚°: startup-debug.shãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‹ç¢ºèª
          jq '.containerDefinitions[0].entryPoint = ["/usr/local/bin/startup-debug.sh"] |
              .containerDefinitions[0].command = ["apache2-foreground"]' \
            task-definition-tmp4.json > task-definition-new.json
          
          echo "=== Task Definition Preview ==="
          jq '.containerDefinitions[0] | {name, image, entryPoint, command}' task-definition-new.json

      #########################################################################
      # 9. ECSã‚¿ã‚¹ã‚¯å®šç¾©ç™»éŒ²
      #########################################################################
      - name: Register new task definition
        if: ${{ !inputs.skip_build }}
        id: task-def
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-definition-new.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "task-definition-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "Registered task definition: $TASK_DEF_ARN"

      #########################################################################
      # 10. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      #########################################################################
      - name: Run Database Migrations
        if: ${{ !inputs.skip_migrations }}
        run: |
          echo "ğŸ—„ï¸ Running database migrations..."
          
          # å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ARNã‚’å–å¾—
          TASK_ARN=$(aws ecs list-tasks \
            --cluster $ECS_CLUSTER \
            --service-name $ECS_SERVICE \
            --desired-status RUNNING \
            --query 'taskArns[0]' \
            --output text)
          
          if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" = "None" ]; then
            echo "âŒ No running tasks found in service $ECS_SERVICE"
            exit 1
          fi
          
          # ã‚¿ã‚¹ã‚¯IDã‚’æŠ½å‡ºï¼ˆARNã‹ã‚‰IDã®ã¿å–å¾—ï¼‰
          TASK_ID=$(echo $TASK_ARN | awk -F/ '{print $NF}')
          echo "ğŸ“‹ Using task: $TASK_ID"
          
          # 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ15ç§’ï¼‰
          echo "ğŸ” Testing database connection..."
          timeout 15 aws ecs execute-command \
            --cluster $ECS_CLUSTER \
            --task $TASK_ID \
            --container app \
            --interactive \
            --command "/bin/bash -c 'php artisan db:show --database=pgsql'" > /dev/null 2>&1 || {
            echo "âŒ Database connection test failed (timeout or connection error)"
            echo "â„¹ï¸ Possible causes:"
            echo "   - Security Group rules not configured"
            echo "   - RDS instance not accessible from ECS"
            echo "   - DB credentials incorrect"
            exit 1
          }
          echo "âœ… Database connection successful"
          
          # 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          echo "ğŸš€ Executing migrations..."
          aws ecs execute-command \
            --cluster $ECS_CLUSTER \
            --task $TASK_ID \
            --container app \
            --interactive \
            --command "/bin/bash -c 'cd /var/www/html && php artisan migrate --force --isolated'" || {
            echo "âŒ Migration failed"
            echo "âš ï¸ Deployment will be aborted"
            exit 1
          }
          
          echo "âœ… Migrations completed successfully"

      #########################################################################
      # 11. ECSã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°ï¼ˆãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼‰
      #########################################################################
      - name: Update ECS service
        id: service-update
        run: |
          # æ–°ã—ã„Task Definitionã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°
          TASK_DEF_ARN="${{ steps.task-def.outputs.task-definition-arn }}"
          if [ -z "$TASK_DEF_ARN" ]; then
            echo "âŒ ERROR: Task Definition ARN not found"
            exit 1
          fi
          
          # ç¾åœ¨ã®Task Definitionã‚’ä¿å­˜ï¼ˆãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
          CURRENT_TASK_DEF=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].taskDefinition' \
            --output text)
          echo "previous-task-definition=$CURRENT_TASK_DEF" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Current Task Definition: $CURRENT_TASK_DEF"
          
          echo "ğŸ“‹ Updating service with Task Definition: $TASK_DEF_ARN"
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --task-definition "$TASK_DEF_ARN" \
            --force-new-deployment \
            --query 'service.{ServiceName:serviceName,Status:status,DesiredCount:desiredCount,TaskDefinition:taskDefinition}'
          
          echo "âœ… ECS service update initiated"

      #########################################################################
      # 12. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿ
      #########################################################################
      - name: Wait for deployment to complete
        id: wait-deployment
        run: |
          echo "â³ Waiting for deployment to complete..."
          
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç´„10åˆ†ï¼‰ã§å¾…æ©Ÿ
          # AWS CLI v2ã§ã¯waiter-max-attempts/waiter-delayã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯éã‚µãƒãƒ¼ãƒˆ
          aws ecs wait services-stable \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE || {
            echo "âŒ Deployment failed or timed out"
            exit 1
          }
          
          echo "âœ… Deployment completed successfully"

      #########################################################################
      # 13. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      #########################################################################
      - name: Application Health Check
        run: |
          echo "ğŸ¥ Performing application health check..."
          
          # Target Group ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          TARGET_GROUP_ARN="arn:aws:elasticloadbalancing:ap-northeast-1:469751479977:targetgroup/myteacher-production-tg/b21e68db3fa99163"
          
          HEALTHY_COUNT=$(aws elbv2 describe-target-health \
            --target-group-arn $TARGET_GROUP_ARN \
            --query 'TargetHealthDescriptions[?TargetHealth.State==`healthy`] | length(@)' \
            --output text)
          
          TOTAL_COUNT=$(aws elbv2 describe-target-health \
            --target-group-arn $TARGET_GROUP_ARN \
            --query 'length(TargetHealthDescriptions)' \
            --output text)
          
          echo "ğŸ“Š Health Status: $HEALTHY_COUNT/$TOTAL_COUNT targets healthy"
          
          if [ "$HEALTHY_COUNT" -eq "0" ]; then
            echo "âŒ No healthy targets found"
            exit 1
          fi
          
          echo "âœ… Application health check passed"

      #########################################################################
      # 14. ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
      #########################################################################
      - name: Deployment success notification
        if: success()
        run: |
          echo "ğŸ‰ MyTeacher App deployed successfully!"
          echo "Cluster: $ECS_CLUSTER"
          echo "Service: $ECS_SERVICE"
          echo "Commit: ${{ github.sha }}"
          echo "Task Definition: ${{ steps.task-def.outputs.task-definition-arn }}"

      #########################################################################
      # 15. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¤±æ•—æ™‚ï¼‰
      #########################################################################
      - name: Rollback on Failure
        if: failure() && steps.service-update.outputs.previous-task-definition != ''
        run: |
          echo "âš ï¸ Deployment failed. Rolling back to previous version..."
          
          PREVIOUS_TASK_DEF="${{ steps.service-update.outputs.previous-task-definition }}"
          echo "ğŸ“‹ Rolling back to: $PREVIOUS_TASK_DEF"
          
          # å‰å›ã®Task Definitionã«æˆ»ã™
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --task-definition "$PREVIOUS_TASK_DEF" \
            --force-new-deployment || {
            echo "âŒ Rollback failed"
            exit 1
          }
          
          echo "â³ Waiting for rollback to complete..."
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§å¾…æ©Ÿ
          aws ecs wait services-stable \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE
          
          echo "âœ… Rollback completed successfully"
          echo "âš ï¸ Please investigate the deployment failure and fix issues before retrying"
