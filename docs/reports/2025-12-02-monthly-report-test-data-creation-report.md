# 月次レポート検証用テストデータ作成完了レポート

## 更新履歴

| 日付 | 更新者 | 更新内容 |
|------|--------|---------|
| 2025-12-02 | GitHub Copilot | 初版作成: 9月・10月分テストデータ作成完了 |

## 概要

MyTeacherシステムの**月次レポート検証用テストデータ**として、testuserが属するグループ（グループID: 1）の全メンバー（6名）の**9月・10月分タスクデータと月次レポート**を作成しました。この作業により、以下の目標を達成しました：

- ✅ **目標1**: 前月比変化検出機能のテスト用データ整備（9月→10月で30%以上変化: 4名）
- ✅ **目標2**: AIコメント生成時のトークン消費量推定データの提供
- ✅ **目標3**: 再現性のある自動テストデータ生成スクリプトの提供

これにより、AI月次コメント機能の動作検証、トークン消費量の実測、料金推定の精度向上が可能になりました。

## 作成データ詳細

### グループ情報

- **グループID**: 1
- **メンバー数**: 6名
  - testuser (ID: 8)
  - testuser2 (ID: 9)
  - testuser3 (ID: 10)
  - testuser4 (ID: 11)
  - testuser5 (ID: 12)
  - testuser6 (ID: 13)

### 9月分データ（2024-09-01）

**月次レポート**: ID 7

| メンバー | 通常タスク | グループタスク | 合計完了 | 報酬 |
|---------|-----------|--------------|---------|------|
| testuser2 | 6/8件 | 4/5件 | 10件 | 1,200トークン |
| testuser4 | 10/12件 | 7/8件 | 17件 | 2,050トークン |
| testuser5 | 8/10件 | 5/6件 | 13件 | 1,550トークン |
| testuser6 | 12/15件 | 9/10件 | 21件 | 2,550トークン |
| testuser3 | 5/6件 | 3/4件 | 8件 | 950トークン |
| testuser | 7/9件 | 5/6件 | 12件 | 1,450トークン |

**集計**:
- 総タスク: 99件
- 完了タスク: 81件
- 完了率: 81.82%
- 総報酬: 9,750トークン

### 10月分データ（2024-10-01）

**月次レポート**: ID 8

| メンバー | 通常タスク | グループタスク | 合計完了 | 報酬 |
|---------|-----------|--------------|---------|------|
| testuser2 | 8/10件 | 7/8件 | 15件 | 1,850トークン |
| testuser4 | 12/15件 | 9/10件 | 21件 | 2,550トークン |
| testuser5 | 8/10件 | 6/7件 | 14件 | 1,700トークン |
| testuser6 | 6/8件 | 4/5件 | 10件 | 1,200トークン |
| testuser3 | 5/7件 | 7/8件 | 12件 | 1,550トークン |
| testuser | 10/12件 | 9/10件 | 19件 | 2,350トークン |

**集計**:
- 総タスク: 110件
- 完了タスク: 91件
- 完了率: 82.73%
- 総報酬: 11,200トークン

### 9月→10月のメンバー変化分析

| メンバー | 9月合計 | 10月合計 | 変化率 | 検出 | タイプ |
|---------|---------|---------|--------|------|--------|
| testuser2 | 10件 | 15件 | +50% | 📈 | 著しい増加 |
| testuser4 | 17件 | 21件 | +24% | ➡️ | 変化なし |
| testuser5 | 13件 | 14件 | +8% | ➡️ | 変化なし |
| testuser6 | 21件 | 10件 | -52% | 📉 | 著しい減少 |
| testuser3 | 8件 | 12件 | +50% | 📈 | 著しい増加 |
| testuser | 12件 | 19件 | +58% | 📈 | 著しい増加 |

**30%閾値での検出結果**: 4名
- 📈 **増加メンバー**: testuser2 (+50%), testuser3 (+50%), testuser (+58%)
- 📉 **減少メンバー**: testuser6 (-52%)

## トークン推定消費量算定

### AIコメント生成時のトークン構成

```
【入力トークン】
├─ ベースプロンプト: 150トークン
│  └─ システムプロンプト（アバター性格設定、ガイドライン）
│
├─ メンバー変化情報: 240トークン
│  └─ 4名 × 60トークン/名
│     ├─ testuser2: 前月10件→今月15件（50%増加）...
│     ├─ testuser6: 前月21件→今月10件（52%減少）...
│     ├─ testuser3: 前月8件→今月12件（50%増加）...
│     └─ testuser: 前月12件→今月19件（58%増加）...
│
├─ ユーザープロンプト: 100トークン
│  └─ レポート実績サマリー（メンバー数、タスク数、報酬）
│
└─ 合計入力: 490トークン

【出力トークン】
└─ AIレスポンス: 300トークン（max_tokens設定値）

【総トークン】
└─ 合計: 790トークン
```

### 料金推定（gpt-4o-mini、2024年12月時点）

| 項目 | トークン数 | 単価 | コスト |
|------|----------|------|--------|
| 入力 | 490 | $0.150/1M | $0.000074 |
| 出力 | 300 | $0.600/1M | $0.000180 |
| **合計** | **790** | - | **$0.000254** |

**円換算**（$1 = ¥150換算）: 約0.038円

**年間コスト推定**（月1回実行 × 12ヶ月）:
- ドルベース: $0.000254 × 12 = $0.003048/年
- 円換算: 約0.46円/年

**スケール推定**（100グループで運用）:
- 月間: $0.000254 × 100 = $0.0254（約3.8円）
- 年間: $0.3048（約45.7円）

## 実装内容

### 作成スクリプト

**ファイル**: `scripts/create-monthly-test-data.php`

**主な機能**:
1. **グループメンバー取得**: 指定グループIDの全メンバーを取得
2. **タスクデータ生成**:
   - 9月分: 各メンバーに通常タスク（6-15件）+ グループタスク（4-10件）
   - 10月分: 前月比で変化を演出（30%閾値を超える変化を含む）
   - 完了率: 通常タスク85%、グループタスク90%
   - 報酬: 通常タスク100トークン/件、グループタスク150トークン/件
3. **月次レポート作成**:
   - `member_task_summary`: メンバー別通常タスク集計
   - `group_task_summary`: メンバー別グループタスク集計
   - 総タスク数、完了タスク数、完了率、総報酬を算出
4. **変化分析**:
   - 9月→10月の各メンバーの変化率計算
   - 30%閾値での検出メンバー抽出
5. **トークン推定**:
   - 入力トークン: ベースプロンプト + 変化情報 + ユーザープロンプト
   - 出力トークン: max_tokens設定値
   - 料金推定: gpt-4o-miniの単価で算出

**実行方法**:
```bash
cd /home/ktr/mtdev
docker exec mtdev-app-1 php scripts/create-monthly-test-data.php
```

**出力**:
- 9月・10月の各メンバーのタスク作成状況
- 月次レポート作成結果（ID、総タスク、完了タスク、完了率、総報酬）
- メンバー変化分析（変化率、検出有無）
- トークン推定（入力/出力/合計）
- 料金推定（ドル/円）

### スクリプトの特徴

**再現性**:
- 既存レポート削除により、何度実行しても同じ結果
- メンバーごとの固定パターンで安定したテストデータ

**リアリティ**:
- 完了率85-90%（現実的な値）
- 月ごとに変化量を調整（+50%, -52%など）
- グループタスクの作成者をローテーション（assigned_by_user_id）

**拡張性**:
- 対象グループID、月範囲、タスク数を変数化
- 新しい月を追加する場合は配列に追加するだけ

## 動作確認

### 月次レポート一覧

```
2024年09月: ID 7  ← 新規作成
2024年10月: ID 8  ← 新規作成
2024年11月: ID 6  （既存）
2025年10月: ID 3  （既存）
2025年11月: ID 1  （既存）
2025年12月: ID 4  （既存）
```

### AIコメント生成テスト（想定）

10月分レポート（ID: 8）でAIコメント生成を実行した場合、以下のようなシステムプロンプトが構築されます：

```
あなたは教師アバターとして、グループの月次タスク実績レポートにコメントを付けます。

【特に注目すべきメンバー】
- testuser2さん: 前月10件→今月15件（50%増加）！素晴らしい成長です。この調子を称賛し、さらなる励みになる言葉をかけてあげてください。
- testuser6さん: 前月21件→今月10件（52%減少）。心配な状況ですが、優しく励まし、前向きな言葉をかけてサポートしてください。
- testuser3さん: 前月8件→今月12件（50%増加）！素晴らしい成長です。この調子を称賛し、さらなる励みになる言葉をかけてあげてください。
- testuserさん: 前月12件→今月19件（58%増加）！素晴らしい成長です。この調子を称賛し、さらなる励みになる言葉をかけてあげてください。

※上記のメンバーの変化を必ずコメントに反映させ、具体的に名前を挙げて言及してください。

...
```

## 今後の活用方法

### 1. 前月比変化検出機能のテスト

```bash
# 10月レポートでAIコメント生成
docker exec mtdev-app-1 php artisan tinker --execute="
\$service = app(\App\Services\Report\MonthlyReportServiceInterface::class);
\$group = \App\Models\Group::find(1);
\$report = \App\Models\MonthlyReport::find(8); // 10月レポート

// AIコメント生成（前月比検出含む）
\$reflection = new \ReflectionClass(\$service);
\$method = \$reflection->getMethod('generateAIComment');
\$method->setAccessible(true);

\$comment = \$method->invoke(\$service, \$group, [
    'report_month' => '2024-10-01',
    'member_task_summary' => \$report->member_task_summary,
    'group_task_summary' => \$report->group_task_summary,
]);

echo \$comment;
"
```

### 2. トークン消費量の実測

```bash
# 実際のOpenAI API呼び出しでトークン数を記録
# OpenAIService::generateMonthlyReportComment()のレスポンスから
# $result['usage']['total_tokens'] を取得
```

### 3. 料金推定の検証

- 推定値: 790トークン、$0.000254
- 実測値: 実際のAPI呼び出し結果と比較
- 誤差分析: プロンプト長の変動要因を特定

### 4. 追加月のテストデータ作成

スクリプトの`$months`配列に追加：

```php
$months = [
    ['year' => 2024, 'month' => 9, 'label' => '9月'],
    ['year' => 2024, 'month' => 10, 'label' => '10月'],
    ['year' => 2024, 'month' => 11, 'label' => '11月'], // 追加
    ['year' => 2024, 'month' => 12, 'label' => '12月'], // 追加
];
```

## 成果と効果

### 定量的効果

- **テストデータ作成**: 9月99件 + 10月110件 = 計209件のタスク
- **月次レポート**: 2件作成（9月ID:7, 10月ID:8）
- **変化検出対象**: 6名中4名（67%）が30%閾値超え
- **トークン推定精度**: ±10%以内の誤差を想定（実測要確認）

### 定性的効果

- **検証環境整備**: AI機能の動作確認が容易に
- **料金透明性**: トークン消費量の可視化で運用コスト予測が可能
- **再現性確保**: スクリプトにより一貫したテストデータ生成
- **拡張性**: 新しい月やグループへの展開が容易

## まとめ

**月次レポート検証用テストデータ**の作成が完了しました。9月・10月分の計209件のタスクと2件の月次レポートが生成され、AI月次コメント機能の前月比変化検出のテストが可能になりました。

**トークン推定**: 1回のAIコメント生成で約790トークン、約0.038円のコストを想定しています。

**次のステップ**: 実際のOpenAI API呼び出しでトークン消費量を実測し、推定値との誤差を検証します。

## 関連ファイル

- **スクリプト**: `scripts/create-monthly-test-data.php` - テストデータ生成
- **確認スクリプト**: `scripts/check-testuser-group.php` - グループ・レポート確認
- **月次レポート**: グループID 1の2024年9月・10月分（ID: 7, 8）
