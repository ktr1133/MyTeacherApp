class d{constructor(){this.currentStep=1,this.totalSteps=5,this.formData=window.avatarDefaults||{sex:"male",hair_color:"black",hair_style:"short",eye_color:"brown",clothing:"casual",accessory:"",body_type:"average",tone:"gentle",enthusiasm:"normal",formality:"polite",humor:"normal",draw_model_version:"anything-v4.0",is_transparent:!0,is_chibi:!1},this.options=window.avatarOptions||{},this.models=window.avatarOptions&&window.avatarOptions.draw_models||{},this.init()}init(){console.log("[Avatar Wizard Child] Initialized"),this.restoreFromStorage(),this.setupEventListeners(),this.updateUI(),window.addEventListener("beforeunload",t=>{this.currentStep>1&&this.currentStep<5&&(t.preventDefault(),t.returnValue="")})}setupEventListeners(){document.querySelectorAll("[data-next-step]").forEach(a=>{a.addEventListener("click",()=>this.nextStep())}),document.querySelectorAll("[data-prev-step]").forEach(a=>{a.addEventListener("click",()=>this.prevStep())}),document.querySelectorAll("[data-select-option]").forEach(a=>{a.addEventListener("click",()=>{const o=a.dataset.selectOption,i=a.dataset.value;this.selectOption(o,i)})}),document.querySelectorAll("[data-select-model]").forEach(a=>{a.addEventListener("click",()=>{const o=a.dataset.selectModel;this.selectModel(o)})});const t=document.querySelector("[data-toggle-transparent]");t&&t.addEventListener("click",()=>{this.formData.is_transparent=!this.formData.is_transparent,this.updateUI(),this.saveToStorage()});const e=document.querySelector("[data-toggle-chibi]");e&&e.addEventListener("click",()=>{this.formData.is_chibi=!this.formData.is_chibi,this.updateUI(),this.saveToStorage()})}updateUI(){const t={1:"ステップ 1: どんなアバターがいい？",2:"ステップ 2: 見た目を選ぼう",3:"ステップ 3: 性格を選ぼう",4:"ステップ 4: 画風を選ぼう",5:"ステップ 5: 確認しよう"},e=document.querySelector("[data-step-title]");e&&(e.textContent=t[this.currentStep]||""),this.updateProgressBar(),document.querySelectorAll("[data-wizard-step]").forEach(s=>{parseInt(s.dataset.wizardStep)===this.currentStep?s.classList.remove("hidden"):s.classList.add("hidden")});const a=document.querySelector("[data-prev-step]");a&&(this.currentStep>1?a.classList.remove("hidden"):a.classList.add("hidden"));const o=document.querySelector("[data-next-btn-container]");o&&(this.currentStep<5?o.classList.remove("hidden"):o.classList.add("hidden"));const i=document.querySelector("[data-final-btn-container]");i&&(this.currentStep===5?i.classList.remove("hidden"):i.classList.add("hidden")),Object.keys(this.formData).forEach(s=>{const r=document.querySelector(`input[name="${s}"]`);r&&(s==="is_transparent"||s==="is_chibi"?r.value=this.formData[s]?"1":"0":r.value=this.formData[s])}),document.querySelectorAll("[data-select-option]").forEach(s=>{const r=s.dataset.selectOption,c=s.dataset.value;this.formData[r]===c?s.classList.add("selection-card-active"):s.classList.remove("selection-card-active")}),document.querySelectorAll("[data-select-model]").forEach(s=>{const r=s.dataset.selectModel;this.formData.draw_model_version===r?s.classList.add("model-card-active"):s.classList.remove("model-card-active")});const n=document.querySelector("[data-toggle-transparent]");n&&(this.formData.is_transparent?n.classList.add("toggle-active"):n.classList.remove("toggle-active"));const l=document.querySelector("[data-toggle-chibi]");l&&(this.formData.is_chibi?l.classList.add("toggle-active"):l.classList.remove("toggle-active")),this.updateConfirmationValues(),this.updateTokenCost()}updateProgressBar(){for(let t=1;t<=this.totalSteps;t++){const e=document.querySelector(`[data-progress-step="${t}"]`);if(e){const o=e.querySelector("[data-step-number]"),i=e.querySelector("[data-step-dot]");e.className="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-300",this.currentStep===t?(e.classList.add("bg-gradient-to-r","from-amber-400","to-orange-400","text-white","shadow-lg","scale-110"),o&&o.classList.remove("hidden"),i&&i.classList.add("hidden")):this.currentStep>t?(e.classList.add("bg-green-500","text-white"),o&&o.classList.remove("hidden"),i&&i.classList.add("hidden")):(e.classList.add("bg-gray-300","text-gray-600"),o&&o.classList.add("hidden"),i&&i.classList.remove("hidden"))}const a=document.querySelector(`[data-progress-line="${t}"]`);a&&t<this.totalSteps&&(a.className="h-1 flex-1 mx-2 transition-all duration-300",this.currentStep>t?a.classList.add("bg-green-500"):a.classList.add("bg-gray-300"))}}updateConfirmationValues(){const t={sex:this.getOptionLabel("sex",this.formData.sex),hair_style:this.getOptionLabel("hair_style",this.formData.hair_style),hair_color:this.getOptionLabel("hair_color",this.formData.hair_color),eye_color:this.getOptionLabel("eye_color",this.formData.eye_color),clothing:this.getOptionLabel("clothing",this.formData.clothing),accessory:this.getOptionLabel("accessory",this.formData.accessory),body_type:this.getOptionLabel("body_type",this.formData.body_type),tone:this.getOptionLabel("tone",this.formData.tone),enthusiasm:this.getOptionLabel("enthusiasm",this.formData.enthusiasm),formality:this.getOptionLabel("formality",this.formData.formality),humor:this.getOptionLabel("humor",this.formData.humor),draw_model_version:this.getModelLabel(this.formData.draw_model_version),is_transparent:this.formData.is_transparent?"する":"しない",is_chibi:this.formData.is_chibi?"する":"しない"};Object.keys(t).forEach(e=>{const a=document.querySelector(`[data-confirm-${e}]`);a&&(a.textContent=t[e])})}updateTokenCost(){const t=this.getTotalCost(),e=document.querySelector("[data-token-cost]");e&&(e.textContent=this.formatNumber(t))}nextStep(){this.currentStep<this.totalSteps&&(this.currentStep++,this.saveToStorage(),this.updateUI(),window.scrollTo({top:0,behavior:"smooth"}))}prevStep(){this.currentStep>1&&(this.currentStep--,this.saveToStorage(),this.updateUI(),window.scrollTo({top:0,behavior:"smooth"}))}selectOption(t,e){this.formData[t]=e,this.saveToStorage(),this.updateUI(),this.currentStep===1&&setTimeout(()=>this.nextStep(),600)}selectModel(t){this.formData.draw_model_version=t,this.saveToStorage(),this.updateUI()}getOptionLabel(t,e){return!this.options[t]||!this.options[t][e]?e||"なし":this.options[t][e].label}getModelLabel(t){return this.models[t]?this.models[t].label:t}getTotalCost(){const t=this.models[this.formData.draw_model_version];return t?t.token_cost:0}formatNumber(t){return t.toLocaleString("ja-JP")}saveToStorage(){try{localStorage.setItem("avatar_wizard_step",this.currentStep),localStorage.setItem("avatar_wizard_data",JSON.stringify(this.formData))}catch(t){console.error("[Storage] Save failed:",t)}}restoreFromStorage(){try{const t=localStorage.getItem("avatar_wizard_step"),e=localStorage.getItem("avatar_wizard_data");if(t&&(this.currentStep=parseInt(t)),e){const a=JSON.parse(e);this.formData={...this.formData,...a}}}catch(t){console.error("[Storage] Restore failed:",t)}}}document.addEventListener("DOMContentLoaded",()=>{new d});
