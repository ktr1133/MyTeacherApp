window.AvatarManager={widget:null,container:null,bubble:null,bubbleText:null,avatarImage:null,closeBtn:null,isVisible:!1,isForcedHidden:!1,displayTimer:null,position:{x:0,y:0},isDragging:!1,dragOffset:{x:0,y:0},init(){if(console.log("[AvatarManager] Initializing..."),this.widget=document.getElementById("avatar-widget"),!this.widget){console.warn("[AvatarManager] Widget element not found");return}this.container=this.widget.querySelector(".avatar-container"),this.bubble=this.widget.querySelector(".avatar-bubble"),this.bubbleText=this.bubble?.querySelector("p"),this.avatarImage=this.widget.querySelector(".avatar-image"),this.closeBtn=this.widget.querySelector(".avatar-close-btn"),this.setInitialPosition(),this.setupEventListeners(),console.log("[AvatarManager] Initialized successfully")},setInitialPosition(){this.position.x=window.innerWidth-270-20,this.position.y=window.innerHeight-350-20,this.updatePosition()},setupEventListeners(){this.closeBtn&&this.closeBtn.addEventListener("click",e=>{e.stopPropagation(),console.log("[AvatarManager] Close button clicked"),this.forceHide()}),window.addEventListener("avatar-event",e=>{console.log("[AvatarManager] Avatar event received:",e.detail),this.handleEvent(e.detail)}),this.widget.addEventListener("mousedown",e=>{this.startDrag(e)}),this.widget.addEventListener("touchstart",e=>{e.touches.length===1&&this.startDrag(e.touches[0])},{passive:!1});let t;window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{this.adjustPositionOnResize()},100)})},handleEvent(t){if(!t||!t.comment){console.warn("[AvatarManager] Invalid event data:",t);return}this.isForcedHidden=!1,this.widget.classList.remove("avatar-force-hidden"),this.updateContent(t),this.show(),this.setAutoHideTimer()},updateContent(t){if(this.bubbleText&&(this.bubbleText.textContent=t.comment||""),this.avatarImage){let e=t.imageUrl;if(!e&&t.expression){const s=`${t.expression}Image`;e=this.widget.dataset[s]}e||(e=this.widget.dataset.defaultImage),e&&(this.avatarImage.src=e);const i=t.animation||"avatar-idle";this.avatarImage.className=`avatar-image ${i}`}},show(){if(this.isForcedHidden){console.log("[AvatarManager] Widget is force hidden, ignoring show()");return}this.widget.classList.remove("hidden","opacity-0","translate-y-4"),this.widget.classList.add("opacity-100","translate-y-0"),this.isVisible=!0},hide(){console.log("[AvatarManager] Hiding widget"),this.widget.classList.remove("opacity-100","translate-y-0"),this.widget.classList.add("opacity-0","translate-y-4"),setTimeout(()=>{this.widget.classList.add("hidden")},200),this.isVisible=!1,this.clearTimer()},forceHide(){this.hide(),this.isForcedHidden=!0,this.widget.classList.add("avatar-force-hidden")},setAutoHideTimer(){this.clearTimer(),this.displayTimer=setTimeout(()=>{this.forceHide()},2e4)},clearTimer(){this.displayTimer&&(clearTimeout(this.displayTimer),this.displayTimer=null)},updatePosition(){this.position.x=Math.max(20,Math.min(this.position.x,window.innerWidth-270-20)),this.position.y=Math.max(20,Math.min(this.position.y,window.innerHeight-350-20)),this.widget.style.left=`${this.position.x}px`,this.widget.style.top=`${this.position.y}px`},adjustPositionOnResize(){this.position.x=Math.min(this.position.x,window.innerWidth-270-20),this.position.y=Math.min(this.position.y,window.innerHeight-350-20),this.updatePosition(),this.isForcedHidden&&this.widget.classList.add("avatar-force-hidden")},startDrag(t){if(t.target.closest(".avatar-close-btn"))return;this.isDragging=!0;const e=t.clientX||t.pageX,i=t.clientY||t.pageY;this.dragOffset.x=e-this.position.x,this.dragOffset.y=i-this.position.y;const s=a=>{if(!this.isDragging)return;a.preventDefault();const o=a.touches?a.touches[0]:a;this.position.x=o.clientX-this.dragOffset.x,this.position.y=o.clientY-this.dragOffset.y,this.updatePosition()},n=()=>{this.isDragging=!1,document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",n),document.removeEventListener("touchmove",s),document.removeEventListener("touchend",n)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",n),document.addEventListener("touchmove",s,{passive:!1}),document.addEventListener("touchend",n)}};window.dispatchAvatarEvent=function(t){console.log("[dispatchAvatarEvent] Called with eventType:",t),console.log("[dispatchAvatarEvent] Call stack:",new Error().stack);const e=performance.now();fetch(`/avatars/comment/${t}`).then(i=>{const s=performance.now()-e;if(console.log("[dispatchAvatarEvent] Fetch response received",{eventType:t,status:i.status,ok:i.ok,fetchTime:`${s.toFixed(2)}ms`}),!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const n=i.headers.get("content-type");if(!n||!n.includes("application/json"))throw console.error("[dispatchAvatarEvent] Expected JSON",{contentType:n,eventType:t}),new Error(`Expected JSON, got ${n}`);return i.json()}).then(i=>{performance.now()-e,i.comment?window.dispatchEvent(new CustomEvent("avatar-event",{detail:{comment:i.comment,imageUrl:i.imageUrl,animation:i.animation}})):console.warn("[dispatchAvatarEvent] No comment in response",{eventType:t,data:i})}).catch(i=>{const s=performance.now()-e;console.error("[dispatchAvatarEvent] ERROR",{eventType:t,error:i.message,stack:i.stack,totalTime:`${s.toFixed(2)}ms`,timestamp:new Date().toISOString()})})};window.showAvatarComment=function(t){if(!t||!t.comment){console.warn("[showAvatarComment] No comment data provided");return}if(!window.AvatarManager||!window.AvatarManager.widget){console.error("[showAvatarComment] AvatarManager not initialized");return}window.dispatchEvent(new CustomEvent("avatar-event",{detail:t}))};document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{window.AvatarManager&&window.AvatarManager.init()},100)});
