class f{static apiBase(){const e=document.querySelector('meta[name="api-base-url"]')?.content?.trim();return(e&&!e.startsWith("http")?`${location.origin}${e}`:e||"/api").replace(/\/+$/,"")}static apiOrigin(){try{return new URL(this.apiBase(),location.origin).origin}catch{return location.origin}}static async ensureCsrfCookie(){const e=this.apiOrigin();e!==location.origin&&await fetch(`${e}/sanctum/csrf-cookie`,{method:"GET",credentials:"include"})}static async propose(e,s,t,a){return this._post("tasks/propose",{title:e,span:s,context:t,is_refinement:a})}static async adopt(e,s){return this._post("tasks/adopt",{proposal_id:e,tasks:s})}static async _post(e,s){await this.ensureCsrfCookie();const t=this.apiBase(),a=e.startsWith("/")?e:`/${e}`,i=`${t}${a}`,r={"Content-Type":"application/json"},n=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");n&&(r["X-CSRF-TOKEN"]=n);const o=await fetch(i,{method:"POST",headers:r,credentials:"include",body:JSON.stringify(s)});if(!o.ok){const l=await o.text().catch(()=>"");throw new Error(`API request to ${i} failed: ${o.status} ${l}`)}return o.json()}}class b{constructor(){this.wrapper=document.getElementById("task-modal-wrapper"),this.content=document.getElementById("task-modal-content"),this.loadingOverlay=document.getElementById("modal-loading-overlay"),this.views={input:document.getElementById("modal-state-1"),decomposition:document.getElementById("modal-state-2"),refine:document.getElementById("modal-state-3")},this.buttons={state1:document.getElementById("state-1-buttons"),state2:document.getElementById("state-2-buttons"),state3:document.getElementById("state-3-buttons")},this.dueDateContainers={short:document.getElementById("due-date-short-container"),mid:document.getElementById("due-date-mid-container"),long:document.getElementById("due-date-long-container")},this.dueDateInputs={short:document.getElementById("due_date_short"),mid:document.getElementById("due_date_mid"),long:document.getElementById("due_date_long")},this.isChildTheme=document.body.classList.contains("child-theme"),this.taskTitleInput=document.getElementById("taskTitle"),this.taskSpanSelect=document.getElementById("taskSpan"),this.simpleRegisterBtn=document.getElementById("simple-register-btn"),this.decomposeBtn=document.getElementById("decompose-btn")}open(){if(!this.wrapper)return;const e=document.getElementById("task-form");e&&e.reset(),document.querySelectorAll(".tag-checkbox").forEach(i=>{i.checked=!1;const r=i.closest(".task-tag-chip");r&&this.updateTagChipStyle(r,!1)});const t=Alpine.store?.("dashboard");t&&(t.taskTitle="",t.taskSpan=2,t.due_date=new Date().getFullYear().toString(),t.refinementPoints="",t.selectedTags=[],t.proposedTasks=[],t.selectedTaskSpans={},t.selectedTaskDueDates=[],t.generatedTag=""),this.switchView("input"),this.hideLoading(),this.taskSpanSelect&&(this.taskSpanSelect.value="2"),this.switchDueDateField(2),this.updateButtonStates();const a=document.getElementById("submit-refine-btn");a&&(a.disabled=!0),this.wrapper.classList.remove("hidden"),this.wrapper.classList.add("flex"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.wrapper.classList.remove("opacity-0"),this.wrapper.classList.add("opacity-100"),this.content.classList.remove("translate-y-4","scale-95"),this.content.classList.add("translate-y-0","scale-100")})}),this.wrapper.setAttribute("data-modal-state","open"),setTimeout(()=>{this.taskTitleInput&&this.taskTitleInput.focus()},350)}updateButtonStates(){const e=this.taskTitleInput?.value.trim()||"",s=e.length>0;console.log("[updateButtonStates] Title:",e,"HasTitle:",s),this.simpleRegisterBtn&&(this.simpleRegisterBtn.disabled=!s),this.decomposeBtn&&(this.decomposeBtn.disabled=!s)}updateTagChipStyle(e,s){const t=this.isChildTheme;s?t?(e.classList.remove("bg-amber-100","text-amber-800"),e.classList.add("bg-amber-500","text-white")):(e.classList.remove("bg-gray-100","text-gray-700"),e.classList.add("bg-[#59B9C6]","text-white")):t?(e.classList.remove("bg-amber-500","text-white"),e.classList.add("bg-amber-100","text-amber-800")):(e.classList.remove("bg-[#59B9C6]","text-white"),e.classList.add("bg-gray-100","text-gray-700"))}switchDueDateField(e){const s=Object.values(this.dueDateContainers).find(n=>n&&n.classList.contains("show"));let t=null,a=null,i="";if(e===1?(t=this.dueDateContainers.short,a=this.dueDateInputs.short,i=new Date().toISOString().split("T")[0]):e===2?(t=this.dueDateContainers.mid,a=this.dueDateInputs.mid,i=new Date().getFullYear().toString()):e===3&&(t=this.dueDateContainers.long,a=this.dueDateInputs.long,i=""),!t||!a){console.error("[switchDueDateField] Target container or input not found");return}if(s===t){console.log("[switchDueDateField] Already showing target container");return}Object.values(this.dueDateInputs).forEach(n=>{n&&(n.disabled=!0)}),a.disabled=!1,a.value=i;const r=Alpine.store?.("dashboard");r&&(r.due_date=i),this.isChildTheme?(s&&s.classList.remove("show"),setTimeout(()=>{Object.values(this.dueDateContainers).forEach(n=>{n&&n!==t&&(n.classList.remove("show"),n.style.display="none")}),t.style.display="block",requestAnimationFrame(()=>{t.classList.add("show")})},300)):(Object.values(this.dueDateContainers).forEach(n=>{n&&(n.classList.remove("show"),n.style.display="none")}),t.style.display="block",t.classList.add("show"))}close(){this.wrapper&&(this.wrapper.classList.remove("opacity-100"),this.wrapper.classList.add("opacity-0"),this.content.classList.remove("translate-y-0","scale-100"),this.content.classList.add("translate-y-4","scale-95"),setTimeout(()=>{this.wrapper.classList.remove("flex"),this.wrapper.classList.add("hidden"),this.wrapper.setAttribute("data-modal-state","closed");const e=Alpine.store?.("dashboard");e&&(e.taskTitle="",e.taskSpan=2,e.due_date=new Date().getFullYear().toString(),e.refinementPoints="",e.selectedTags=[],e.proposedTasks=[],e.selectedTaskSpans={},e.selectedTaskDueDates=[],e.generatedTag="")},300))}switchView(e){Object.entries(this.views).forEach(([s,t])=>{if(t)if(s===e){if(t.style.display="block",window.Alpine&&s==="decomposition"&&Alpine.nextTick(()=>{const a=Alpine.store("dashboard");this.renderProposedTasks(a?.proposedTasks||[],a?.generatedTag||"")}),s==="refine"){const a=document.getElementById("refinementPoints");a&&(a.value="");const i=document.getElementById("submit-refine-btn");i&&(i.disabled=!0)}}else t.style.display="none"}),Object.entries(this.buttons).forEach(([s,t])=>{t&&(e==="input"&&s==="state1"||e==="decomposition"&&s==="state2"||e==="refine"&&s==="state3"?t.style.display="flex":t.style.display="none")})}renderProposedTasks(e,s){const t=document.getElementById("generated-tag-display");t&&(t.textContent=s||"タグなし");const a=document.getElementById("proposed-task-count"),i=document.getElementById("adopt-task-count");a&&(a.textContent=e.length),i&&(i.textContent=e.length);const r=document.getElementById("adopt-proposal-btn");r&&(r.disabled=e.length===0);const n=document.getElementById("tasks-list"),o=document.getElementById("no-tasks-message");if(!n||!o)return;if(!e||e.length===0){o.style.display="block",n.innerHTML="";return}o.style.display="none";const l=Alpine.store("dashboard"),c=e.map((u,h)=>{const m=l?.selectedTaskSpans?.[h]||2;let p=l?.selectedTaskDueDates?.[h]||"";if(!p&&(m==1?p=new Date().toISOString().split("T")[0]:m==2?p=new Date().getFullYear().toString():p="",l&&l.selectedTaskDueDates)){const g=[...l.selectedTaskDueDates];g[h]=p,l.selectedTaskDueDates=g}return`
                <div class="task-list flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 transition bg-white">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-[#59B9C6] text-white text-xs font-bold">${h+1}</span>
                            <p class="font-medium break-words">${this.escapeHtml(u.title||"無題のタスク")}</p>
                        </div>

                        <div class="mt-2 flex items-center gap-2">
                            <label class="text-sm text-gray-600 whitespace-nowrap">期間:</label>
                            <select
                                class="task-span-select text-sm border rounded px-2 py-1 pr-8 bg-white"
                                data-task-index="${h}">
                                <option value="1" ${m==1?"selected":""}>短期</option>
                                <option value="2" ${m==2?"selected":""}>中期</option>
                                <option value="3" ${m==3?"selected":""}>長期</option>
                            </select>
                        </div>

                        <div class="mt-2 due-date-container" data-task-index="${h}">
                            ${this.renderDueDateField(h,m,p)}
                        </div>
                    </div>

                    <button
                        type="button"
                        class="task-remove-btn text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded flex-shrink-0 transition"
                        data-remove-index="${h}"
                        title="このタスクを削除">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `}).join("");n.innerHTML=c,this.bindTaskSpanChangeEvents(),this.bindTaskRemoveEvents()}renderDueDateField(e,s,t){const r=new Date().toISOString().split("T")[0],n=new Date().getFullYear(),o=Array.from({length:6},(l,c)=>n+c);return s==1?`
                <div>
                    <label class="block text-xs text-gray-600 mb-1">期限（日付）</label>
                    <input type="date"
                        class="task-due-date w-full border rounded px-2 py-1 text-sm"
                        data-task-index="${e}"
                        min="${r}"
                        value="${t}">
                </div>
            `:s==2?`
                <div>
                    <label class="block text-xs text-gray-600 mb-1">期限（年）</label>
                    <select
                        class="task-due-date w-full border rounded px-2 py-1 text-sm pr-8"
                        data-task-index="${e}">
                        <option value="">選択してください</option>
                        ${o.map(l=>`<option value="${l}" ${t==l?"selected":""}>${l}年</option>`).join("")}
                    </select>
                </div>
            `:`
                <div>
                    <label class="block text-xs text-gray-600 mb-1">期限（任意）</label>
                    <input type="text"
                        class="task-due-date w-full border rounded px-2 py-1 text-sm"
                        data-task-index="${e}"
                        placeholder="例：5年後"
                        value="${t}">
                </div>
            `}bindTaskSpanChangeEvents(){document.querySelectorAll(".task-span-select").forEach(s=>{s.addEventListener("change",t=>{const a=parseInt(t.target.getAttribute("data-task-index")),i=parseInt(t.target.value),r=Alpine.store("dashboard");if(r){r.setTaskSpan(a,i);let n="";i==1?n=new Date().toISOString().split("T")[0]:i==2&&(n=new Date().getFullYear().toString());const o=[...r.selectedTaskDueDates];o[a]=n,r.selectedTaskDueDates=o;const l=document.querySelector(`.due-date-container[data-task-index="${a}"]`);l&&(l.innerHTML=this.renderDueDateField(a,i,n),this.bindDueDateChangeEvents())}})}),this.bindDueDateChangeEvents()}bindDueDateChangeEvents(){document.querySelectorAll(".task-due-date").forEach(s=>{s.addEventListener("change",t=>{const a=parseInt(t.target.getAttribute("data-task-index")),i=t.target.value,r=Alpine.store("dashboard");if(r&&r.selectedTaskDueDates){const n=[...r.selectedTaskDueDates];n[a]=i,r.selectedTaskDueDates=n}})})}bindTaskRemoveEvents(){document.querySelectorAll(".task-remove-btn").forEach(s=>{s.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const a=parseInt(s.getAttribute("data-remove-index")),i=Alpine.store("dashboard");i&&!isNaN(a)&&(i.removeProposedTask(a),this.renderProposedTasks(i.proposedTasks,i.generatedTag))})})}escapeHtml(e){const s=document.createElement("div");return s.textContent=e,s.innerHTML}showLoading(){this.loadingOverlay&&(this.loadingOverlay.classList.remove("hidden"),this.loadingOverlay.classList.add("flex"))}showLoadingWithMessage(e){if(this.loadingOverlay){const s=document.getElementById("modal-loading-text");s&&e&&(s.textContent=e),this.loadingOverlay.classList.remove("hidden"),this.loadingOverlay.classList.add("flex")}}hideLoading(){if(this.loadingOverlay){this.loadingOverlay.classList.remove("flex"),this.loadingOverlay.classList.add("hidden");const e=document.getElementById("modal-loading-text");if(e){const s=this.isChildTheme;e.textContent=s?"クエストを分解しています...":"AIでタスクを分解しています..."}}}isOpen(){return this.wrapper?.getAttribute("data-modal-state")==="open"}}class w{constructor(){this.showTaskModal=!1,this.showDecompositionModal=!1,this.showRefineModal=!1,this.isProposing=!1,this.taskTitle="",this.taskSpan="",this.refinementPoints="",this.decompositionProposal=null,this.proposedTasks=[],this.selectedTaskSpans={},this.selectedTaskDueDates=[],this.generatedTag=""}reset(){this.showTaskModal=!1,this.showDecompositionModal=!1,this.showRefineModal=!1,this.isProposing=!1,this.taskTitle="",this.refinementPoints="",this.proposedTasks=[],this.selectedTaskSpans={},this.selectedTaskDueDates=[],this.generatedTag=""}}document.addEventListener("alpine:init",()=>{Alpine.store("dashboard",{showTaskModal:!1,showDecompositionModal:!1,showRefineModal:!1,isProposing:!1,taskTitle:"",taskSpan:2,due_date:new Date().getFullYear().toString(),refinementPoints:"",decompositionProposal:null,selectedTags:[],proposedTasks:[],selectedTaskSpans:{},selectedTaskDueDates:[],generatedTag:"",removeProposedTask(d){this.proposedTasks=this.proposedTasks.filter((s,t)=>t!==d);const e={};Object.keys(this.selectedTaskSpans).forEach(s=>{const t=parseInt(s);t<d?e[t]=this.selectedTaskSpans[s]:t>d&&(e[t-1]=this.selectedTaskSpans[s])}),this.selectedTaskSpans=e,this.selectedTaskDueDates=this.selectedTaskDueDates.filter((s,t)=>t!==d)},setTaskSpan(d,e){this.selectedTaskSpans[d]=e,e===1?this.selectedTaskDueDates[d]=new Date().toISOString().split("T")[0]:e===2?this.selectedTaskDueDates[d]=new Date().getFullYear().toString():this.selectedTaskDueDates[d]=""},updateFromController(d){this.showTaskModal=!!d.showTaskModal,this.showDecompositionModal=!!d.showDecompositionModal,this.showRefineModal=!!d.showRefineModal,this.isProposing=!!d.isProposing,this.taskTitle=d.taskTitle||this.taskTitle,this.taskSpan=d.taskSpan||this.taskSpan,this.due_date=d.due_date??this.due_date,this.refinementPoints=d.refinementPoints||this.refinementPoints,this.generatedTag=d.generatedTag??this.generatedTag,d.decompositionProposal!==void 0&&(this.decompositionProposal=d.decompositionProposal),d.selectedTags!==void 0&&(this.selectedTags=[...d.selectedTags||[]]),d.proposedTasks!==void 0&&(this.proposedTasks=[...d.proposedTasks||[]]),d.selectedTaskSpans!==void 0&&(this.selectedTaskSpans={...d.selectedTaskSpans||{}}),d.selectedTaskDueDates!==void 0&&(this.selectedTaskDueDates=[...d.selectedTaskDueDates||[]])}})});class T{constructor(){this.state=new w,this.modal=new b}async decomposeTask(e=!1){let s="",t=2,a=null;const i=document.getElementById("taskTitle"),r=document.getElementById("taskSpan"),n=document.getElementById("refinementPoints");i&&(s=i.value.trim()),r&&(t=parseInt(r.value,10)),e&&n&&(a=n.value.trim());const o=window.Alpine&&Alpine.store?Alpine.store("dashboard"):null;if(!s&&o?.taskTitle&&(s=o.taskTitle.trim()),!t&&o?.taskSpan&&(t=o.taskSpan),e&&!a&&o?.refinementPoints&&(a=o.refinementPoints.trim()),!s&&this.state.taskTitle&&(s=this.state.taskTitle.trim()),!s||s===""){window.showAlertDialog?window.showAlertDialog("タスク名を入力してください。","エラー",()=>{i&&i.focus()}):(alert("タスク名を入力してください。"),i&&i.focus());return}if(e&&(!a||a==="")){window.showAlertDialog?window.showAlertDialog("再提案の観点を入力してください。","エラー",()=>{n&&n.focus()}):(alert("再提案の観点を入力してください。"),n&&n.focus());return}try{this.modal.showLoading(),this.updateState({isProposing:!0});const l=await f.propose(s,t,a,e);let c=l.proposed_tasks||[];if(typeof c=="string")try{c=JSON.parse(c)}catch{c=this._parseTaskList(c)}Array.isArray(c)||(c=[]);const u=c.map((p,g)=>typeof p=="string"?{title:p,originalSpan:t}:p&&typeof p=="object"?{title:p.title||p.name||"",originalSpan:t}:{title:"",originalSpan:t}).filter(p=>p.title.trim()!=="");if(u.length===0){window.showAlertDialog?window.showAlertDialog("タスクの分解に失敗しました。提案されたタスクがありません。","エラー"):alert("タスクの分解に失敗しました。提案されたタスクがありません。"),this.modal.hideLoading(),this.updateState({isProposing:!1});return}const h={};u.forEach((p,g)=>{h[g]=t});const m=Array(u.length).fill("");this.updateState({decompositionProposal:{proposal_id:l.proposal_id,proposed_tasks:l.proposed_tasks,model_used:l.model_used},proposedTasks:u,selectedTaskSpans:h,selectedTaskDueDates:m,generatedTag:s,isProposing:!1}),this.modal.hideLoading(),this.modal.switchView("decomposition")}catch(l){const c=`タスクの分解中にエラーが発生しました。
`+(l.message||"");window.showAlertDialog?window.showAlertDialog(c,"エラー"):alert(c),this.modal.hideLoading(),this.updateState({isProposing:!1})}}_parseTaskList(e){return!e||typeof e!="string"?[]:e.split(/\r?\n/).map(s=>s.trim()).filter(s=>s.length>0).map(s=>{const t=s.match(/^(?:[-*]|\d+\.)\s*(.+)$/);return t?t[1].trim():s}).filter(s=>s.length>0)}async confirmProposal(){const e=window.Alpine&&Alpine.store?Alpine.store("dashboard"):null,s=e?.proposedTasks??this.state.proposedTasks,t=e?.selectedTaskSpans??this.state.selectedTaskSpans,a=e?.selectedTaskDueDates||[];if(console.log("[confirmProposal] Store Data",{proposedTasks:s,selectedTaskSpans:t,dueDates:a,store:e?{selectedTaskDueDates:e.selectedTaskDueDates}:null}),!s||s.length===0)return;if(s.some((r,n)=>!t[n])){window.showAlertDialog?window.showAlertDialog("すべてのタスクにスパンを選択してください。","エラー"):alert("すべてのタスクにスパンを選択してください。");return}try{this.modal.showLoadingWithMessage(this.modal.isChildTheme?"クエストを作成しています...":"タスクを作成しています..."),this.updateState({isProposing:!0});const r=s.map((l,c)=>({title:l.title,span:t[c],due_date:a[c]||null,tags:[e.generatedTag]})),n=e?.decompositionProposal??this.state.decompositionProposal,o=await f.adopt(n.proposal_id??n.id,r);if(console.log("[confirmProposal] Response received",o),o.success)this.showToast(o.message,"success"),o.avatar_comment&&typeof window.showAvatarComment=="function"&&(console.log("[confirmProposal] Showing avatar comment:",o.avatar_comment),window.showAvatarComment(o.avatar_comment)),this.updateState({showDecompositionModal:!1,decompositionProposal:null,proposedTasks:[],selectedTaskSpans:{},selectedTaskDueDates:[],generatedTag:"",isProposing:!1}),this.modal.close(),this.modal.hideLoading(),o.html&&this.updateTaskListWithHTML(o.html);else throw new Error(o.message||"タスクの作成に失敗しました。")}catch(r){this.modal.hideLoading(),this.updateState({isProposing:!1}),this.showToast(r.message||"タスクの作成中にエラーが発生しました","error"),console.error("[confirmProposal] Error:",r)}}showToast(e,s="success"){console.log("[showToast]",{message:e,type:s});const t=document.getElementById("dynamic-toast");t&&t.remove();const a=document.createElement("div");a.id="dynamic-toast",a.className="fixed top-4 right-4 z-50 max-w-sm w-full",a.setAttribute("role","alert"),a.setAttribute("aria-live","assertive"),a.setAttribute("aria-atomic","true");const i={success:{bg:"bg-green-50",border:"border-green-500",text:"text-green-800",icon:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"},error:{bg:"bg-red-50",border:"border-red-500",text:"text-red-800",icon:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"},warning:{bg:"bg-yellow-50",border:"border-yellow-500",text:"text-yellow-800",icon:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"},info:{bg:"bg-blue-50",border:"border-blue-500",text:"text-blue-800",icon:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"}},r=i[s]||i.success;a.innerHTML=`
            <div class="flex items-start p-4 rounded-lg shadow-lg border-l-4 ${r.bg} ${r.border} ${r.text}">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${r.icon}" />
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-sm font-medium">${this.escapeHtml(e)}</p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button class="toast-close inline-flex rounded-md hover:opacity-75">
                        <span class="sr-only">閉じる</span>
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        `,document.body.appendChild(a),requestAnimationFrame(()=>{a.style.opacity="0",a.style.transform="translateY(8px)",a.style.transition="opacity 300ms ease-out, transform 300ms ease-out",requestAnimationFrame(()=>{a.style.opacity="1",a.style.transform="translateY(0)"})});const n=a.querySelector(".toast-close"),o=()=>{a.style.opacity="0",a.style.transform="translateY(8px)",setTimeout(()=>a.remove(),200)};n&&n.addEventListener("click",o),setTimeout(o,5e3)}escapeHtml(e){const s=document.createElement("div");return s.textContent=e,s.innerHTML}updateTaskListWithHTML(e){const s=document.querySelector("#task-list-container");if(!s){console.error("[updateTaskListWithHTML] Task list container not found");return}s.innerHTML=e,window.Alpine&&Alpine.initTree(s),console.log("[updateTaskListWithHTML] Task list updated with server-rendered HTML")}updateTaskList(e,s){if(!e||e.length===0)return;let t=null;const a=document.querySelectorAll("[data-bucket-name]");for(const n of a)if(n.getAttribute("data-bucket-name")===s){t=n;break}if(!t){this.createNewBucket(s,e);return}const i=t.querySelector(".task-list-container");if(!i){console.warn("[updateTaskList] Task list container not found");return}const r=i.querySelector(".empty-state");r&&r.remove(),e.forEach(n=>{const o=this.createTaskCard(n);i.insertAdjacentHTML("beforeend",o)})}createNewBucket(e,s){const t=s.map(o=>this.createTaskCard(o)).join(""),a=`
            <div class="bento-card group relative rounded-2xl shadow-lg hover:shadow-2xl p-6 cursor-pointer" data-bucket-name="${this.escapeHtml(e)}">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#59B9C6] to-[#3b82f6] flex items-center justify-center shadow-lg">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-900 dark:text-white">${this.escapeHtml(e)}</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${s.length}件のタスク</p>
                        </div>
                    </div>
                </div>
                <div class="task-list-container space-y-3">
                    ${t}
                </div>
            </div>
        `,i=document.querySelector("#task-list-container");if(!i){console.warn("[createNewBucket] Task list container not found");return}const r=i.querySelector(".empty-state");r&&r.remove();let n=i.querySelector(".bento-grid");n||(n=document.createElement("div"),n.className="bento-grid grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6",i.appendChild(n)),n.insertAdjacentHTML("afterbegin",a)}createTaskCard(e){const s={1:"短期",2:"中期",3:"長期"},t={1:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",2:"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300",3:"bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-300"},a=s[e.span]||"中期",i=t[e.span]||t[2],r=e.due_date?`<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">期限: ${this.escapeHtml(e.due_date)}</p>`:"";return`
            <div class="task-card group bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2 break-words">${this.escapeHtml(e.title)}</h4>
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${i}">
                                ${a}
                            </span>
                        </div>
                        ${r}
                    </div>
                    <div class="flex items-center gap-1">
                        <form method="POST" action="/tasks/${e.id}/toggle" class="inline">
                            <input type="hidden" name="_token" value="${document.querySelector('meta[name="csrf-token"]')?.content}">
                            <input type="hidden" name="_method" value="PATCH">
                            <button type="submit" class="task-toggle-btn p-2 rounded-lg text-gray-400 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 transition" title="完了にする">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        `}updateState(e){Object.assign(this.state,e),window.Alpine&&Alpine.store&&Alpine.store("dashboard")&&Alpine.store("dashboard").updateFromController(this.state)}}class y{constructor(e){this.dashboard=e,this.boundHandlers=new Map,this.initialized=!1}init(){this.initialized||(this.initialized=!0,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.#t()}):this.#t())}#t(){this.#e("open-task-modal-btn",()=>{this.dashboard.modal.open()}),this.#e("close-modal-btn",()=>{this.dashboard.modal.close()});const e=document.getElementById("task-modal-wrapper");if(e){const o=l=>{l.target===e&&this.dashboard.modal.close()};e.addEventListener("click",o),this.boundHandlers.set("task-modal-wrapper-click",o)}const s=o=>{o.key==="Escape"&&this.dashboard.modal.isOpen()&&this.dashboard.modal.close()};document.addEventListener("keydown",s),this.boundHandlers.set("escape-key",s);const t=document.getElementById("taskTitle");if(t){const o=l=>{const c=Alpine.store?.("dashboard");c&&(c.taskTitle=l.target.value),this.dashboard.state.taskTitle=l.target.value,this.dashboard.modal.updateButtonStates()};t.addEventListener("input",o),this.boundHandlers.set("taskTitle-input",o)}const a=document.getElementById("taskSpan");if(a){const o=l=>{const c=parseInt(l.target.value,10);console.log("[spanHandler] Span changed to:",c);const u=Alpine.store?.("dashboard");u&&(u.taskSpan=c),this.dashboard.state.taskSpan=c,this.dashboard.modal.switchDueDateField(c)};a.addEventListener("change",o),this.boundHandlers.set("taskSpan-change",o)}document.querySelectorAll(".tag-checkbox").forEach(o=>{o.addEventListener("change",l=>{const c=l.target.closest(".task-tag-chip");c&&this.dashboard.modal.updateTagChipStyle(c,l.target.checked);const u=Alpine.store?.("dashboard");if(u){const h=parseInt(l.target.value);l.target.checked?u.selectedTags.includes(h)||(u.selectedTags=[...u.selectedTags,h]):u.selectedTags=u.selectedTags.filter(m=>m!==h)}})});const r=document.getElementById("refinementPoints");if(r){const o=l=>{const c=Alpine.store?.("dashboard");c&&(c.refinementPoints=l.target.value),this.dashboard.state.refinementPoints=l.target.value,this.updateRefineButtonState()};r.addEventListener("input",o),this.boundHandlers.set("refinementPoints-input",o)}this.#e("decompose-btn",()=>{this.dashboard.decomposeTask(!1)}),this.#e("adopt-proposal-btn",()=>{this.dashboard.confirmProposal()}),this.#e("cancel-decomposition-btn",()=>{this.dashboard.modal.switchView("input")}),this.#e("refine-proposal-btn",()=>{this.dashboard.modal.switchView("refine")}),this.#e("cancel-refine-btn",()=>{this.dashboard.modal.switchView("decomposition")}),this.#e("submit-refine-btn",()=>{this.dashboard.decomposeTask(!0)});const n=document.getElementById("simple-register-btn");if(n){const o=l=>{const c=document.getElementById("task-form");if(c&&!c.checkValidity()){c.reportValidity(),l.preventDefault();return}};n.addEventListener("click",o,{once:!1})}}#e(e,s){if(this.boundHandlers.has(e))return;const t=document.getElementById(e);if(!t)return;const a=i=>{i?.preventDefault?.(),i?.stopPropagation?.(),s.call(this,i)};t.addEventListener("click",a,{once:!1}),this.boundHandlers.set(e,a)}updateRefineButtonState(){const e=document.getElementById("submit-refine-btn");if(!e)return;const t=document.getElementById("refinementPoints")?.value.trim().length>0;e.disabled=!t}destroy(){this.boundHandlers.forEach((e,s)=>{if(s==="escape-key")document.removeEventListener("keydown",e);else if(s==="task-modal-wrapper-click"){const t=document.getElementById("task-modal-wrapper");t&&t.removeEventListener("click",e)}else if(s==="taskSpan-change"){const t=document.getElementById("taskSpan");t&&t.removeEventListener("change",e)}else if(s==="taskTitle-input"){const t=document.getElementById("taskTitle");t&&t.removeEventListener("input",e)}else if(s==="refinementPoints-input"){const t=document.getElementById("refinementPoints");t&&t.removeEventListener("input",e)}else{const t=document.getElementById(s);t&&t.removeEventListener("click",e)}}),this.boundHandlers.clear(),this.initialized=!1}}let k=!1;document.addEventListener("alpine:init",()=>{if(k)return;k=!0;const d=new T,e=new y(d);window.dashboard=d,window.decomposeTask=(...s)=>d.decomposeTask(...s),window.acceptProposal=()=>d.confirmProposal(),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{e.init()}):e.init(),Alpine.store("toast",{visible:!1,message:"",type:"success",timer:null,show(s,t="success"){this.message=s,this.type=t,this.visible=!0,this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.hide()},5e3)},hide(){this.visible=!1,this.timer&&(clearTimeout(this.timer),this.timer=null)}})});
