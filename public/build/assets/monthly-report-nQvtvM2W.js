document.addEventListener("DOMContentLoaded",function(){const r=document.getElementById("year-select"),i=document.getElementById("month-select");if(r&&i){const e=()=>{const n=r.value,o=i.value.padStart(2,"0"),x=r.dataset.routeBase||"/reports/monthly";window.location.href=`${x}/${n}/${o}`};r.addEventListener("change",e),i.addEventListener("change",e)}const m=document.getElementById("month-picker");m&&m.addEventListener("change",function(){const[e,n]=this.value.split("-"),o=this.dataset.routeBase||"/reports/monthly";window.location.href=`${o}/${e}/${n}`});const u=document.getElementById("trend-data");if(!u){console.warn("Trend data element not found");return}const t=JSON.parse(u.textContent);if(!t||!t.total?.datasets?.length){console.warn("No trend data available");return}console.log("Trend data loaded:",{totalDatasetCount:t.total?.datasets?.length||0,normalDatasetCount:t.normal?.datasets?.length||0,groupDatasetCount:t.group?.datasets?.length||0,rewardDatasetCount:t.reward?.datasets?.length||0,members:t.members});const s=document.documentElement.classList.contains("dark"),d={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top",align:"start",labels:{color:s?"#e5e7eb":"#374151",font:{size:12,weight:"500"},boxWidth:20,boxHeight:12,padding:12,usePointStyle:!0,pointStyle:"circle"},maxHeight:80},title:{display:!1},tooltip:{mode:"index",intersect:!1,backgroundColor:s?"rgba(31, 41, 55, 0.95)":"rgba(255, 255, 255, 0.95)",titleColor:s?"#f3f4f6":"#111827",bodyColor:s?"#e5e7eb":"#374151",borderColor:s?"#4b5563":"#d1d5db",borderWidth:1,padding:12,callbacks:{label:function(e){return e.dataset.label+": "+e.parsed.y+"ä»¶"}}}},scales:{x:{grid:{display:!1},ticks:{color:s?"#9ca3af":"#6b7280",font:{size:11}}},y:{beginAtZero:!0,ticks:{stepSize:2,color:s?"#9ca3af":"#6b7280",font:{size:11}},grid:{color:s?"#374151":"#e5e7eb"}}},interaction:{mode:"nearest",axis:"x",intersect:!1}},l=JSON.parse(JSON.stringify(d));l.scales.x.stacked=!0,l.scales.y.stacked=!0,l.scales.y.ticks.stepSize=1,l.plugins.legend.labels.pointStyle="rectRounded";const h=document.getElementById("total-trend-chart");h&&t.total?.datasets?.length>0&&new Chart(h,{type:"line",data:{labels:t.total.labels,datasets:t.total.datasets},options:d});const p=document.getElementById("reward-trend-chart");if(p&&t.reward?.datasets?.length>0){const e=JSON.parse(JSON.stringify(d));e.plugins.tooltip.callbacks={label:function(n){let o=n.dataset.label||"";return o&&(o+=": "),n.parsed.y!==null&&(o+=n.parsed.y.toLocaleString()),o}},new Chart(p,{type:"line",data:{labels:t.reward.labels,datasets:t.reward.datasets},options:e})}let y=null,b=null,c=!1;function C(){if(c)return;const e=document.getElementById("normal-trend-chart");e&&t.normal?.datasets?.length>0&&!y&&(y=new Chart(e,{type:"bar",data:{labels:t.normal.labels,datasets:t.normal.datasets},options:l}));const n=document.getElementById("group-trend-chart");n&&t.group?.datasets?.length>0&&!b&&(b=new Chart(n,{type:"bar",data:{labels:t.group.labels,datasets:t.group.datasets},options:l})),c=!0}const f=document.getElementById("toggle-detail-charts"),a=document.getElementById("detail-charts"),g=document.getElementById("toggle-icon");f&&a&&g&&f.addEventListener("click",function(){if(a.style.maxHeight&&a.style.maxHeight!=="0px")g.classList.remove("rotate-180"),a.style.maxHeight="0",a.style.opacity="0";else{g.classList.add("rotate-180"),a.style.maxHeight="none";const n=a.scrollHeight;a.style.maxHeight="0",requestAnimationFrame(()=>{a.style.maxHeight=n+"px",a.style.opacity="1"}),c||setTimeout(()=>{C(),setTimeout(()=>{a.style.maxHeight=a.scrollHeight+"px"},100)},50)}})});
