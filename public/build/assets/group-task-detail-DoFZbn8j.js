class d{constructor(e){this.taskId=e,this.modal=document.getElementById(`group-task-detail-modal-${e}`),this.overlay=this.modal?.querySelector(".modal-overlay"),this.content=this.modal?.querySelector(".modal-content"),this.closeBtn=this.modal?.querySelector(".modal-close-btn"),this.form=document.getElementById(`approval-form-${e}`),this.fileInput=document.getElementById(`approval-images-${e}`),this.previewContainer=document.getElementById(`preview-container-${e}`),this.submitBtn=this.modal?.querySelector(".submit-approval-btn"),this.previewImages=[],this.modal&&this.init()}init(){window.addEventListener(`open-task-modal-${this.taskId}`,()=>this.open()),this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close()),this.overlay&&this.overlay.addEventListener("click",e=>{e.target===this.overlay&&this.close()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&!this.modal.classList.contains("hidden")&&this.close()}),this.fileInput&&this.fileInput.addEventListener("change",e=>this.handleImageSelect(e)),this.submitBtn&&this.updateSubmitButton()}open(){this.modal&&(this.modal.classList.remove("hidden"),document.body.classList.add("overflow-hidden"),requestAnimationFrame(()=>{this.overlay?.classList.remove("opacity-0"),this.overlay?.classList.add("opacity-100"),this.content?.classList.remove("opacity-0","scale-95"),this.content?.classList.add("opacity-100","scale-100")}))}close(){this.modal&&(this.overlay?.classList.remove("opacity-100"),this.overlay?.classList.add("opacity-0"),this.content?.classList.remove("opacity-100","scale-100"),this.content?.classList.add("opacity-0","scale-95"),setTimeout(()=>{this.modal.classList.add("hidden"),document.body.classList.remove("overflow-hidden"),this.clearPreviews()},300))}handleImageSelect(e){const t=Array.from(e.target.files),n=3-parseInt(this.fileInput.dataset.existingCount||"0");if(t.length>n){alert(`画像は最大${n}枚までアップロードできます。`),e.target.value="";return}this.previewImages=[],this.previewContainer&&(this.previewContainer.innerHTML=""),t.forEach((s,o)=>{const r=new FileReader;r.onload=l=>{this.previewImages.push({url:l.target.result,name:s.name,size:(s.size/1024).toFixed(2)+" KB",index:o}),this.renderPreview({url:l.target.result,name:s.name,size:(s.size/1024).toFixed(2)+" KB",index:o}),this.updateSubmitButton()},r.readAsDataURL(s)})}renderPreview(e){if(!this.previewContainer)return;const t=document.createElement("div");t.className="relative group",t.dataset.index=e.index,t.innerHTML=`
            <img src="${e.url}" 
                 class="w-full h-32 object-cover rounded-lg border"
                 alt="${e.name}">
            <div class="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-xs p-1 rounded-b-lg">
                <p class="truncate">${e.name}</p>
                <p>${e.size}</p>
            </div>
            <button type="button"
                    class="preview-remove-btn absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition"
                    data-index="${e.index}">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        `,t.querySelector(".preview-remove-btn").addEventListener("click",()=>this.removePreview(e.index)),this.previewContainer.appendChild(t),this.previewContainer.parentElement?.classList.remove("hidden")}removePreview(e){this.previewImages=this.previewImages.filter(i=>i.index!==e);const t=this.previewContainer?.querySelector(`[data-index="${e}"]`);t&&t.remove(),this.fileInput&&(this.fileInput.value=""),this.previewImages.length===0&&this.previewContainer&&this.previewContainer.parentElement?.classList.add("hidden"),this.updateSubmitButton()}clearPreviews(){this.previewImages=[],this.previewContainer&&(this.previewContainer.innerHTML="",this.previewContainer.parentElement?.classList.add("hidden")),this.fileInput&&(this.fileInput.value="")}updateSubmitButton(){if(!this.submitBtn)return;const e=this.submitBtn.dataset.requiresImage==="true",t=parseInt(this.submitBtn.dataset.existingImages||"0"),i=this.previewImages.length;e&&t===0&&i===0?this.submitBtn.disabled=!0:this.submitBtn.disabled=!1}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll('[id^="group-task-detail-modal-"]').forEach(e=>{const t=e.id.replace("group-task-detail-modal-","");new d(t)})});window.openGroupTaskDetailModal=function(a){window.dispatchEvent(new CustomEvent(`open-task-modal-${a}`))};
