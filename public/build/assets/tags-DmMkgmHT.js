(function(){const n=document.getElementById("tag-task-modal"),v=[document.getElementById("close-tag-task-modal"),document.getElementById("close-tag-task-modal-bottom")],i=document.getElementById("linked-tasks"),k=document.getElementById("linked-count"),r=document.getElementById("available-task-select"),l=document.getElementById("attach-task-btn"),E=document.getElementById("current-tag-badge");if(!n){console.error("tag-task-modal element not found");return}const b=document.getElementById("tag-page"),d=b?.dataset.appOrigin||window.location.origin,c=b?.dataset.tagsBase||"/tags";function g(t,e){switch(e){case"fetch":return`${d}${c}/${t}/tasks`;case"attach":return`${d}${c}/${t}/tasks/attach`;case"detach":return`${d}${c}/${t}/tasks/detach`;default:return`${d}${c}`}}let s=null,u="";function w(){return document.querySelector('meta[name="csrf-token"]')?.content||""}function x(){n.classList.remove("hidden"),n.classList.add("flex"),n.setAttribute("data-modal-state","open"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{n.classList.remove("opacity-0","translate-y-4","scale-95"),n.classList.add("opacity-100","translate-y-0","scale-100")})}),console.log("Modal opened")}function h(){n.classList.remove("opacity-100","translate-y-0","scale-100"),n.classList.add("opacity-0","translate-y-4","scale-95"),setTimeout(()=>{n.classList.remove("flex"),n.classList.add("hidden"),n.setAttribute("data-modal-state","closed"),s=null,u="",i.innerHTML="",r.innerHTML="",l.disabled=!0},300),location.reload()}async function p(t){const e=g(t,"fetch"),a=await fetch(e,{headers:{Accept:"application/json"},credentials:"include"});if(!a.ok)throw new Error("Failed to load tasks");return a.json()}function m(t){if(i.innerHTML="",!t||t.length===0){i.innerHTML=`
                <li class="p-8 text-center text-gray-400 dark:text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-2 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <p class="text-sm">このタグに紐づくタスクはありません</p>
                </li>
            `,k.textContent="0";return}k.textContent=`${t.length}`,t.forEach(e=>{const a=document.createElement("li");a.className="p-4 flex items-start sm:items-center gap-3 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition group",a.innerHTML=`
                <div class="min-w-0 flex-1">
                    <p class="text-sm font-medium text-gray-800 dark:text-white break-words" title="${y(e.title)}">${y(e.title)}</p>
                </div>
                <button class="tag-detach-btn shrink-0 relative inline-flex items-center justify-center w-8 h-8 rounded-full transition-all duration-200 group/btn"
                        data-action="detach" data-task-id="${e.id}"
                        type="button"
                        aria-label="タグから解除">
                    <span class="tag-detach-btn-bg absolute inset-0 rounded-full bg-gradient-to-br from-red-50 to-pink-50 dark:from-red-950/30 dark:to-pink-950/30 opacity-0 group-hover/btn:opacity-100 transition-opacity duration-200"></span>
                    <span class="tag-detach-btn-border absolute inset-0 rounded-full border-2 border-red-200 dark:border-red-800 group-hover/btn:border-red-400 dark:group-hover/btn:border-red-600 transition-colors duration-200"></span>
                    <svg class="tag-detach-btn-icon relative z-10 w-4 h-4 text-red-500 dark:text-red-400 group-hover/btn:text-red-600 dark:group-hover/btn:text-red-300 group-hover/btn:rotate-90 transition-all duration-200" 
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `,i.appendChild(a)})}function y(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,a=>e[a])}function f(t){r.innerHTML="";const e=document.createElement("option");if(e.value="",e.textContent="タスクを選択してください",r.appendChild(e),!t||t.length===0){r.disabled=!0,l.disabled=!0;return}t.forEach(a=>{const o=document.createElement("option");o.value=String(a.id),o.textContent=a.title,r.appendChild(o)}),r.disabled=!1,r.addEventListener("change",function(){l.disabled=!this.value})}async function L(t,e){const a=g(t,"attach");if(!(await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":w(),Accept:"application/json"},credentials:"include",body:JSON.stringify({task_id:e})})).ok)throw new Error("Attach failed")}async function T(t,e){const a=g(t,"detach");if(!(await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":w(),Accept:"application/json"},credentials:"include",body:JSON.stringify({task_id:e,_method:"DELETE"})})).ok)throw new Error("Detach failed")}document.addEventListener("click",async t=>{const e=t.target.closest('[data-action="open-tag-modal"]');if(e){t.preventDefault(),t.stopPropagation(),s=e.getAttribute("data-tag-id"),u=e.getAttribute("data-tag-name")||"",console.log("Tag ID:",s),console.log("Tag Name:",u),E.textContent=u;try{const a=await p(s);m(a.linked||[]),f(a.available||[]),x()}catch(a){console.error("Failed to fetch tasks:",a),window.showAlertDialog?window.showAlertDialog("タスクの取得に失敗しました。","エラー"):alert("タスクの取得に失敗しました。")}}}),i.addEventListener("click",async t=>{const e=t.target.closest('[data-action="detach"]');if(!e)return;t.preventDefault(),t.stopPropagation();const a=e.getAttribute("data-task-id");try{await T(s,a);const o=await p(s);m(o.linked||[]),f(o.available||[])}catch(o){console.error(o),window.showAlertDialog?window.showAlertDialog("タスクの解除に失敗しました。","エラー"):alert("タスクの解除に失敗しました。")}}),l.addEventListener("click",async()=>{const t=r.value;if(t)try{await L(s,t);const e=await p(s);m(e.linked||[]),f(e.available||[])}catch(e){console.error(e),window.showAlertDialog?window.showAlertDialog("タスクの追加に失敗しました。","エラー"):alert("タスクの追加に失敗しました。")}}),v.forEach(t=>t?.addEventListener("click",h)),n.addEventListener("click",t=>{t.target===n&&h()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&!n.classList.contains("hidden")&&h()})})();
