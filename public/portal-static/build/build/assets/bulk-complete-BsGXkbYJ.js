(function(){function r(){const e=document.querySelectorAll(".bulk-complete-btn");e.forEach(o=>{o.addEventListener("click",u)}),console.log(`[BulkComplete] Initialized ${e.length} buttons`)}function u(e){e.stopPropagation();const o=e.currentTarget;if(o.dataset.hasGroupTask==="true"){typeof window.showAlertDialog=="function"?window.showAlertDialog(`このタグにはグループタスクが含まれているため、一括操作できません。
グループタスクは個別に操作してください。`,"一括操作不可"):alert(`このタグにはグループタスクが含まれているため、一括操作できません。
グループタスクは個別に操作してください。`);return}const t=o.dataset.bucketTasks?.split(",").filter(Boolean)||[],n=o.dataset.bucketName||"このタグ",a=o.dataset.isCompleted==="true";if(t.length===0){console.warn("[BulkComplete] No tasks found");return}const d=a?"完了":"未完了に戻す",l=`「${n}」のタスク${t.length}件を${d}にしますか？`;if(typeof window.showConfirmDialog!="function"){console.error("[BulkComplete] Confirm dialog not available"),alert(l),confirm(l)&&i(t,a);return}window.showConfirmDialog(l,()=>i(t,a))}async function i(e,o){const s=document.querySelector('meta[name="csrf-token"]')?.content;if(!s){console.error("[BulkComplete] CSRF token not found"),alert("認証エラーが発生しました。ページを再読み込みしてください。");return}try{const t=await fetch("/tasks/bulk-complete",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":s,Accept:"application/json"},body:JSON.stringify({task_ids:e.map(a=>parseInt(a,10)),is_completed:o})});if(!t.ok){const a=await t.json().catch(()=>({}));throw new Error(a.message||`HTTP ${t.status}`)}const n=await t.json();console.log("[BulkComplete] Success:",n),n.message&&sessionStorage.setItem("flash_success",n.message),n.avatar_event&&(console.log("[BulkComplete] Saving avatar event for after reload:",n.avatar_event),sessionStorage.setItem("pending_avatar_event",n.avatar_event)),console.log("[BulkComplete] Reloading page..."),window.location.reload()}catch(t){console.error("[BulkComplete] Error:",t),alert(`タスクの一括更新に失敗しました: ${t.message}`)}}function c(){const e=sessionStorage.getItem("pending_avatar_event");e&&(console.log("[BulkComplete] Found pending avatar event:",e),sessionStorage.removeItem("pending_avatar_event"),setTimeout(()=>{typeof window.dispatchAvatarEvent=="function"?(console.log("[BulkComplete] Dispatching saved avatar event:",e),window.dispatchAvatarEvent(e)):console.warn("[BulkComplete] dispatchAvatarEvent not available yet")},500))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{r(),c()}):(r(),c())})();
