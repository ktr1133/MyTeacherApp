document.addEventListener("DOMContentLoaded",function(){console.log("[Avatar Edit] Initializing...");const l=document.getElementById("mobile-menu-toggle");l&&l.addEventListener("click",function(){window.sidebarController&&window.sidebarController.openMobile()}),E(),y(),console.log("[Avatar Edit] Initialization complete")});function E(){const l=document.getElementById("expression-slider");if(!l){console.log("[Expression Slider] Container not found, skipping initialization");return}const u=l.dataset.expressions,m=l.dataset.isChibi==="true";if(!u){console.error("[Expression Slider] No expressions data found");return}let r;try{r=JSON.parse(u)}catch(e){console.error("[Expression Slider] Failed to parse expressions data:",e);return}console.log("[Expression Slider] Loaded expressions:",r.length,"isChibi:",m);const t={currentIndex:0,touchStartX:0,touchEndX:0,minSwipeDistance:50},h=document.getElementById("slider-bg"),o=document.getElementById("slider-images"),c=document.getElementById("thumbnail-list"),g=document.documentElement.classList.contains("child-theme");function p(){const e=r[t.currentIndex];if(e&&e.image&&h){const n=e.image.s3_url||e.image.public_url;h.style.backgroundImage=`url('${n}')`}}function b(){if(!o)return;o.innerHTML="";const e=r[t.currentIndex],n=document.createElement("div");n.className="relative";const i=document.createElement("div");if(i.className=`absolute top-3 left-3 z-20 ${g?"avatar-expression-label-child":"avatar-expression-label"}`,i.innerHTML=`<span class="font-bold">${e.label}</span>`,n.appendChild(i),e.image){const a=document.createElement("img");a.src=e.image.s3_url||e.image.public_url,a.alt=e.label,a.className=`w-full h-auto rounded-lg relative z-10 ${g?"avatar-image":""}`,n.appendChild(a)}else{const a=document.createElement("div");a.className="aspect-square flex flex-col items-center justify-center text-center p-6 bg-gray-50 dark:bg-gray-900 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-700 relative z-10",a.innerHTML=`
                <svg class="w-12 h-12 text-gray-400 dark:text-gray-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <p class="text-sm text-gray-600 dark:text-gray-400 font-medium">生成中...</p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">${e.label}画像</p>
            `,n.appendChild(a)}o.appendChild(n)}function f(){if(!c){console.error("[Expression Slider] Thumbnail list element not found");return}console.log("[Expression Slider] Rendering thumbnails for",r.length,"expressions"),c.innerHTML="",r.forEach((e,n)=>{const i=document.createElement("button");if(i.type="button",i.className=`avatar-thumbnail ${n===t.currentIndex?"avatar-thumbnail-active":"avatar-thumbnail-inactive"}`,i.setAttribute("aria-label",e.label),i.dataset.index=n,e.image){const s=document.createElement("img");s.src=e.image.s3_url||e.image.public_url,s.alt=e.label,s.className="w-full h-full object-cover rounded-lg",i.appendChild(s)}else{const s=document.createElement("div");s.className="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded-lg",s.innerHTML=`
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                `,i.appendChild(s)}const a=document.createElement("div");a.className=`absolute bottom-0 left-0 right-0 ${g?"avatar-thumbnail-label-child":"avatar-thumbnail-label"}`,a.innerHTML=`<span class="text-xs font-semibold truncate block px-1">${e.label}</span>`,i.appendChild(a),i.addEventListener("click",()=>{console.log("[Expression Slider] Thumbnail clicked:",n,e.label),v(n)}),c.appendChild(i)}),console.log("[Expression Slider] Thumbnails rendered:",c.children.length)}function v(e){e>=0&&e<r.length&&(t.currentIndex=e,d())}function d(){p(),b(),x()}function x(){if(!c)return;c.querySelectorAll("button").forEach((n,i)=>{i===t.currentIndex?(n.classList.add("avatar-thumbnail-active"),n.classList.remove("avatar-thumbnail-inactive")):(n.classList.remove("avatar-thumbnail-active"),n.classList.add("avatar-thumbnail-inactive"))})}o&&(o.addEventListener("touchstart",e=>{t.touchStartX=e.touches[0].clientX}),o.addEventListener("touchmove",e=>{t.touchEndX=e.touches[0].clientX}),o.addEventListener("touchend",()=>{const e=t.touchStartX-t.touchEndX;e<-50?t.currentIndex>0&&(t.currentIndex--,d()):e>t.minSwipeDistance&&t.currentIndex<r.length-1&&(t.currentIndex++,d()),t.touchStartX=0,t.touchEndX=0}),o.addEventListener("click",e=>{const n=o.getBoundingClientRect(),i=e.clientX-n.left,a=n.width/2;i<a?t.currentIndex>0&&(t.currentIndex--,d(),console.log("[Expression Slider] PC click: previous",t.currentIndex)):t.currentIndex<r.length-1&&(t.currentIndex++,d(),console.log("[Expression Slider] PC click: next",t.currentIndex))}),o.style.cursor="pointer"),f(),d(),console.log("[Expression Slider] Initialized successfully")}function y(){const l=document.getElementById("avatar-form");if(!l){console.log("[Avatar Form] Form not found, skipping initialization");return}let u=!1;l.addEventListener("submit",function(m){if(u){m.preventDefault();return}u=!0;const r=l.querySelector('button[type="submit"]');r&&(r.disabled=!0,r.textContent="更新中...")}),console.log("[Avatar Form] Initialized successfully")}
