class i{constructor(){this.searchInput=null,this.filterSelect=null,this.resultsContainer=null,this.searchTimeout=null,this.currentFocusIndex=-1,this.searchResults=[],this.currentSearchType="title",this.currentTerms=[],this.currentOperator="or"}init(){if(this.searchInput=document.querySelector('input[type="search"]'),this.filterSelect=document.querySelector("select"),!this.searchInput){console.warn("Search element not found");return}this.createResultsContainer(),this.setupEventListeners()}createResultsContainer(){this.resultsContainer=document.createElement("div"),this.resultsContainer.id="search-results",this.resultsContainer.className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 hidden max-h-96 overflow-y-auto";const e=this.searchInput.closest(".relative");e&&e.appendChild(this.resultsContainer)}setupEventListeners(){this.searchInput.addEventListener("input",e=>{if(clearTimeout(this.searchTimeout),e.target.value.trim()===""){this.hideResults(),this.resetDashboard();return}this.searchTimeout=setTimeout(()=>{this.performSearch(e.target.value)},300)}),this.searchInput.addEventListener("keydown",e=>{if(!this.resultsContainer.classList.contains("hidden"))switch(e.key){case"ArrowDown":e.preventDefault(),this.focusNext();break;case"ArrowUp":e.preventDefault(),this.focusPrevious();break;case"Enter":e.preventDefault(),this.selectCurrent();break;case"Escape":this.hideResults();break;case"Tab":e.shiftKey?(e.preventDefault(),this.focusPrevious()):(e.preventDefault(),this.focusNext());break}}),this.filterSelect&&this.filterSelect.addEventListener("change",e=>{this.applyFilter(e.target.value)}),document.addEventListener("click",e=>{!this.searchInput.contains(e.target)&&!this.resultsContainer.contains(e.target)&&this.hideResults()})}async performSearch(e){try{const t=this.parseSearchQuery(e);this.currentSearchType=t.type,this.currentTerms=t.terms,this.currentOperator=t.operator;const r=await this.searchTasks(t);this.searchResults=r.tasks||[],this.displayResults(this.searchResults)}catch(t){console.error("Search error:",t),this.showError("検索中にエラーが発生しました")}}parseSearchQuery(e){const t={type:"title",terms:[],operator:"or"};return e.startsWith("#")&&(t.type="tag",e=e.substring(1)),e.includes("&")?(t.operator="and",t.terms=e.split("&").map(r=>r.trim()).filter(r=>r)):(t.operator="or",t.terms=e.split(/\s+/).filter(r=>r)),t}async searchTasks(e){const t=new URL("/tasks/search",window.location.origin);t.searchParams.append("type",e.type),t.searchParams.append("operator",e.operator),e.terms.forEach(n=>t.searchParams.append("terms[]",n));const r=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),a={Accept:"application/json","X-Requested-With":"XMLHttpRequest"};r&&(a["X-CSRF-TOKEN"]=r);const s=await fetch(t,{method:"GET",headers:a,credentials:"include"});if(!s.ok)throw new Error(`Search failed: ${s.status}`);return s.json()}displayResults(e){if(this.currentFocusIndex=-1,!e||e.length===0){this.resultsContainer.innerHTML='<div class="p-4 text-gray-500 dark:text-gray-400 text-center">検索結果は0件でした</div>',this.resultsContainer.classList.remove("hidden");return}this.currentSearchType==="tag"?this.displayTagResults(e):this.displayTaskResults(e)}displayTaskResults(e){const t=e.map((r,a)=>{const s=r.tags?.map(c=>`#${c}`).join(" ")||"",n=this.formatSpan(r.span),o=r.due_date||"-";return`
                <div class="search-result-item p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-b-0 transition" 
                     data-index="${a}"
                     data-task-id="${r.id}"
                     data-result-type="task"
                     tabindex="0">
                    <div class="font-medium text-gray-900 dark:text-white">${this.escapeHtml(r.title)}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        <span class="text-[#59B9C6] dark:text-[#6BCAD7]">${s}</span>
                        <span class="mx-2">|</span>
                        <span>${n}</span>
                        <span class="mx-2">|</span>
                        <span>${o}</span>
                    </div>
                </div>
            `}).join("");this.resultsContainer.innerHTML=t,this.resultsContainer.classList.remove("hidden"),this.resultsContainer.querySelectorAll(".search-result-item").forEach((r,a)=>{r.addEventListener("click",()=>{this.navigateToSearchResults()}),r.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),this.currentFocusIndex=a,this.navigateToSearchResults())})})}displayTagResults(e){const t={};e.forEach(a=>{a.tags?.forEach(s=>{t[s]||(t[s]=[]),t[s].push(a)})});const r=Object.entries(t).map(([a,s],n)=>`
                <div class="search-result-item p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-b-0 transition" 
                     data-index="${n}"
                     data-tag-name="${a}"
                     data-result-type="tag"
                     tabindex="0">
                    <div class="font-medium text-[#59B9C6] dark:text-[#6BCAD7]">#${this.escapeHtml(a)}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        ${s.length}件のタスク
                    </div>
                </div>
            `).join("");this.resultsContainer.innerHTML=r,this.resultsContainer.classList.remove("hidden"),this.resultsContainer.querySelectorAll(".search-result-item").forEach((a,s)=>{a.addEventListener("click",()=>{this.navigateToSearchResults()}),a.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),this.currentFocusIndex=s,this.navigateToSearchResults())})})}navigateToSearchResults(){const e=new URLSearchParams({type:this.currentSearchType,operator:this.currentOperator});this.currentTerms.forEach(t=>e.append("terms[]",t)),window.location.href=`/tasks/search/results?${e.toString()}`}resetDashboard(){const e=document.querySelector(".grid");if(!e)return;e.querySelectorAll(":scope > div").forEach(r=>{r.style.display="flex"}),this.hideResetButton()}hideResetButton(){const e=document.getElementById("reset-filter-btn");e&&(e.style.display="none")}formatSpan(e){return{1:"短期",2:"中期",3:"長期",short:"短期",mid:"中期",long:"長期"}[e]||e}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}showError(e){this.resultsContainer.innerHTML=`<div class="p-4 text-red-500 dark:text-red-400 text-center">${e}</div>`,this.resultsContainer.classList.remove("hidden")}hideResults(){this.resultsContainer.classList.add("hidden"),this.currentFocusIndex=-1}focusNext(){const e=this.resultsContainer.querySelectorAll(".search-result-item");e.length!==0&&(this.currentFocusIndex=(this.currentFocusIndex+1)%e.length,this.updateFocus(e))}focusPrevious(){const e=this.resultsContainer.querySelectorAll(".search-result-item");e.length!==0&&(this.currentFocusIndex=this.currentFocusIndex<=0?e.length-1:this.currentFocusIndex-1,this.updateFocus(e))}updateFocus(e){e.forEach((t,r)=>{r===this.currentFocusIndex?(t.classList.add("bg-gray-100","dark:bg-gray-700"),t.scrollIntoView({block:"nearest"}),t.focus()):t.classList.remove("bg-gray-100","dark:bg-gray-700")})}selectCurrent(){const e=this.resultsContainer.querySelectorAll(".search-result-item");this.currentFocusIndex>=0&&this.currentFocusIndex<e.length&&this.navigateToSearchResults()}applyFilter(e){const t=document.querySelector(".grid");if(!t)return;const r=Array.from(t.querySelectorAll(":scope > div")).filter(s=>s.style.display!=="none"),a=r.map(s=>s.querySelector("[data-task-id]")).filter(Boolean);e==="期限順"?this.sortByDueDate(a,r):e==="タグ"&&this.sortByTag(a,r)}sortByDueDate(e,t){const r=e.map((s,n)=>({task:s,wrapper:t[n],dueDate:s.dataset.dueDate||"9999-12-31"}));r.sort((s,n)=>s.dueDate.localeCompare(n.dueDate));const a=t[0]?.parentElement;a&&r.forEach(({wrapper:s})=>a.appendChild(s))}sortByTag(e,t){const r=e.map((s,n)=>({task:s,wrapper:t[n],tag:s.dataset.tags?.split(",")[0]||""}));r.sort((s,n)=>s.tag.localeCompare(n.tag));const a=t[0]?.parentElement;a&&r.forEach(({wrapper:s})=>a.appendChild(s))}}window.TaskSearchController=i;window.taskSearchController=null;document.addEventListener("DOMContentLoaded",()=>{window.taskSearchController=new i,window.taskSearchController.init()});
