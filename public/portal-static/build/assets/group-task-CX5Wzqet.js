const a=document.getElementById("group-task-modal-wrapper"),l=document.getElementById("group-task-modal-content"),y=document.getElementById("open-group-task-modal-btn"),g=document.getElementById("close-group-modal-btn"),v=document.getElementById("cancel-group-task-btn"),n=document.getElementById("group-task-form"),k=document.querySelectorAll('input[name="task_mode"]'),c=document.getElementById("new-task-form"),p=document.getElementById("template-task-form"),o=document.getElementById("taskTemplate"),m=document.getElementById("template-preview");y&&y.addEventListener("click",()=>{f(a,l)});g&&g.addEventListener("click",()=>{i(a,l),r()});v&&v.addEventListener("click",()=>{i(a,l),r()});a&&a.addEventListener("click",e=>{e.target===a&&(i(a,l),r())});k.forEach(e=>{e.addEventListener("change",t=>{t.target.value==="new"?(c.style.display="block",p.style.display="none",document.getElementById("groupTaskTitle").required=!0,o.required=!1):(c.style.display="none",p.style.display="block",document.getElementById("groupTaskTitle").required=!1,o.required=!0)})});o&&o.addEventListener("change",e=>{const t=e.target.options[e.target.selectedIndex];if(t.value){const u=t.dataset.title||"",s=t.dataset.description||"説明なし";document.getElementById("preview-title").textContent=u,document.getElementById("preview-description").textContent=s,m.style.display="block"}else m.style.display="none"});n&&n.addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(n);if(t.get("task_mode")==="template"){const s=o.options[o.selectedIndex];t.set("title",s.dataset.title),t.set("description",s.dataset.description||"")}t.set("span","1");try{const s=await fetch(n.action,{method:"POST",body:t,headers:{"X-Requested-With":"XMLHttpRequest"}});if(s.ok){const d=await s.json();i(a,l),r(),d.avatar_event&&(console.log("[Group Task] Dispatching avatar event:",d.avatar_event),window.dispatchAvatarEvent?window.dispatchAvatarEvent(d.avatar_event):console.error("[Group Task] dispatchAvatarEvent not found"))}else{const d=await s.json();alert("タスクの作成に失敗しました: "+(d.message||"不明なエラー"))}}catch(s){console.error("[Group Task] Error:",s),alert("タスクの作成中にエラーが発生しました。")}});function r(){n&&(n.reset(),c.style.display="block",p.style.display="none",m.style.display="none")}function f(e,t){e.classList.remove("hidden"),e.setAttribute("data-modal-state","open"),requestAnimationFrame(()=>{e.classList.remove("opacity-0"),e.classList.add("flex","opacity-100"),t.classList.remove("translate-y-4","scale-95"),t.classList.add("translate-y-0","scale-100")})}function i(e,t){e.classList.remove("opacity-100"),e.classList.add("opacity-0"),t.classList.remove("translate-y-0","scale-100"),t.classList.add("translate-y-4","scale-95"),setTimeout(()=>{e.classList.add("hidden"),e.classList.remove("flex"),e.setAttribute("data-modal-state","closed")},300)}
