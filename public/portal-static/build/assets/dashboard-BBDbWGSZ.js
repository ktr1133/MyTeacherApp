class f{static apiBase(){const e=document.querySelector('meta[name="api-base-url"]')?.content?.trim();return(e&&!e.startsWith("http")?`${location.origin}${e}`:e||"/api").replace(/\/+$/,"")}static apiOrigin(){try{return new URL(this.apiBase(),location.origin).origin}catch{return location.origin}}static async ensureCsrfCookie(){const e=this.apiOrigin();e!==location.origin&&await fetch(`${e}/sanctum/csrf-cookie`,{method:"GET",credentials:"include"})}static async propose(e,t,s,a){return this._post("tasks/propose",{title:e,span:t,context:s,is_refinement:a})}static async adopt(e,t){return this._post("tasks/adopt",{proposal_id:e,tasks:t})}static async _post(e,t){await this.ensureCsrfCookie();const s=this.apiBase(),a=e.startsWith("/")?e:`/${e}`,n=`${s}${a}`,r={"Content-Type":"application/json"},o=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");o&&(r["X-CSRF-TOKEN"]=o);const i=await fetch(n,{method:"POST",headers:r,credentials:"include",body:JSON.stringify(t)});if(!i.ok){const l=await i.text().catch(()=>"");throw new Error(`API request to ${n} failed: ${i.status} ${l}`)}return i.json()}}class b{constructor(){this.wrapper=document.getElementById("task-modal-wrapper"),this.content=document.getElementById("task-modal-content"),this.loadingOverlay=document.getElementById("modal-loading-overlay"),this.views={input:document.getElementById("modal-state-1"),decomposition:document.getElementById("modal-state-2"),refine:document.getElementById("modal-state-3")},this.buttons={state1:document.getElementById("state-1-buttons"),state2:document.getElementById("state-2-buttons"),state3:document.getElementById("state-3-buttons")},this.dueDateContainers={short:document.getElementById("due-date-short-container"),mid:document.getElementById("due-date-mid-container"),long:document.getElementById("due-date-long-container")},this.dueDateInputs={short:document.getElementById("due_date_short"),mid:document.getElementById("due_date_mid"),long:document.getElementById("due_date_long")},this.isChildTheme=document.body.classList.contains("child-theme"),this.taskTitleInput=document.getElementById("taskTitle"),this.taskSpanSelect=document.getElementById("taskSpan"),this.simpleRegisterBtn=document.getElementById("simple-register-btn"),this.decomposeBtn=document.getElementById("decompose-btn")}open(){if(!this.wrapper)return;const e=document.getElementById("task-form");e&&e.reset(),document.querySelectorAll(".tag-checkbox").forEach(n=>{n.checked=!1;const r=n.closest(".task-tag-chip");r&&this.updateTagChipStyle(r,!1)});const s=Alpine.store?.("dashboard");s&&(s.taskTitle="",s.taskSpan=2,s.due_date=new Date().getFullYear().toString(),s.refinementPoints="",s.selectedTags=[],s.proposedTasks=[],s.selectedTaskSpans={},s.selectedTaskDueDates=[],s.generatedTag=""),this.switchView("input"),this.hideLoading(),this.taskSpanSelect&&(this.taskSpanSelect.value="2"),this.switchDueDateField(2),this.updateButtonStates();const a=document.getElementById("submit-refine-btn");a&&(a.disabled=!0),this.wrapper.classList.remove("hidden"),this.wrapper.classList.add("flex"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.wrapper.classList.remove("opacity-0"),this.wrapper.classList.add("opacity-100"),this.content.classList.remove("translate-y-4","scale-95"),this.content.classList.add("translate-y-0","scale-100")})}),this.wrapper.setAttribute("data-modal-state","open"),setTimeout(()=>{this.taskTitleInput&&this.taskTitleInput.focus()},350)}updateButtonStates(){const e=this.taskTitleInput?.value.trim()||"",t=e.length>0;console.log("[updateButtonStates] Title:",e,"HasTitle:",t),this.simpleRegisterBtn&&(this.simpleRegisterBtn.disabled=!t),this.decomposeBtn&&(this.decomposeBtn.disabled=!t)}updateTagChipStyle(e,t){const s=this.isChildTheme;t?s?(e.classList.remove("bg-amber-100","text-amber-800"),e.classList.add("bg-amber-500","text-white")):(e.classList.remove("bg-gray-100","text-gray-700"),e.classList.add("bg-[#59B9C6]","text-white")):s?(e.classList.remove("bg-amber-500","text-white"),e.classList.add("bg-amber-100","text-amber-800")):(e.classList.remove("bg-[#59B9C6]","text-white"),e.classList.add("bg-gray-100","text-gray-700"))}switchDueDateField(e){const t=Object.values(this.dueDateContainers).find(o=>o&&o.classList.contains("show"));let s=null,a=null,n="";if(e===1?(s=this.dueDateContainers.short,a=this.dueDateInputs.short,n=new Date().toISOString().split("T")[0]):e===2?(s=this.dueDateContainers.mid,a=this.dueDateInputs.mid,n=new Date().getFullYear().toString()):e===3&&(s=this.dueDateContainers.long,a=this.dueDateInputs.long,n=""),!s||!a){console.error("[switchDueDateField] Target container or input not found");return}if(t===s){console.log("[switchDueDateField] Already showing target container");return}Object.values(this.dueDateInputs).forEach(o=>{o&&(o.disabled=!0)}),a.disabled=!1,a.value=n;const r=Alpine.store?.("dashboard");r&&(r.due_date=n),this.isChildTheme?(t&&t.classList.remove("show"),setTimeout(()=>{Object.values(this.dueDateContainers).forEach(o=>{o&&o!==s&&(o.classList.remove("show"),o.style.display="none")}),s.style.display="block",requestAnimationFrame(()=>{s.classList.add("show")})},300)):(Object.values(this.dueDateContainers).forEach(o=>{o&&(o.classList.remove("show"),o.style.display="none")}),s.style.display="block",s.classList.add("show"))}close(){this.wrapper&&(this.wrapper.classList.remove("opacity-100"),this.wrapper.classList.add("opacity-0"),this.content.classList.remove("translate-y-0","scale-100"),this.content.classList.add("translate-y-4","scale-95"),setTimeout(()=>{this.wrapper.classList.remove("flex"),this.wrapper.classList.add("hidden"),this.wrapper.setAttribute("data-modal-state","closed");const e=Alpine.store?.("dashboard");e&&(e.taskTitle="",e.taskSpan=2,e.due_date=new Date().getFullYear().toString(),e.refinementPoints="",e.selectedTags=[],e.proposedTasks=[],e.selectedTaskSpans={},e.selectedTaskDueDates=[],e.generatedTag="")},300))}switchView(e){Object.entries(this.views).forEach(([t,s])=>{if(s)if(t===e){if(s.style.display="block",window.Alpine&&t==="decomposition"&&Alpine.nextTick(()=>{const a=Alpine.store("dashboard");this.renderProposedTasks(a?.proposedTasks||[],a?.generatedTag||"")}),t==="refine"){const a=document.getElementById("refinementPoints");a&&(a.value="");const n=document.getElementById("submit-refine-btn");n&&(n.disabled=!0)}}else s.style.display="none"}),Object.entries(this.buttons).forEach(([t,s])=>{s&&(e==="input"&&t==="state1"||e==="decomposition"&&t==="state2"||e==="refine"&&t==="state3"?s.style.display="flex":s.style.display="none")})}renderProposedTasks(e,t){const s=document.getElementById("generated-tag-display");s&&(s.textContent=t||"タグなし");const a=document.getElementById("proposed-task-count"),n=document.getElementById("adopt-task-count");a&&(a.textContent=e.length),n&&(n.textContent=e.length);const r=document.getElementById("adopt-proposal-btn");r&&(r.disabled=e.length===0);const o=document.getElementById("tasks-list"),i=document.getElementById("no-tasks-message");if(!o||!i)return;if(!e||e.length===0){i.style.display="block",o.innerHTML="";return}i.style.display="none";const l=Alpine.store("dashboard"),c=e.map((u,h)=>{const m=l?.selectedTaskSpans?.[h]||2;let p=l?.selectedTaskDueDates?.[h]||"";if(!p&&(m==1?p=new Date().toISOString().split("T")[0]:m==2?p=new Date().getFullYear().toString():p="",l&&l.selectedTaskDueDates)){const g=[...l.selectedTaskDueDates];g[h]=p,l.selectedTaskDueDates=g}return`
                <div class="task-list flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 transition bg-white">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-[#59B9C6] text-white text-xs font-bold">${h+1}</span>
                            <p class="font-medium break-words">${this.escapeHtml(u.title||"無題のタスク")}</p>
                        </div>

                        <div class="mt-2 flex items-center gap-2">
                            <label class="text-sm text-gray-600 whitespace-nowrap">期間:</label>
                            <select
                                class="task-span-select text-sm border rounded px-2 py-1 pr-8 bg-white"
                                data-task-index="${h}">
                                <option value="1" ${m==1?"selected":""}>短期</option>
                                <option value="2" ${m==2?"selected":""}>中期</option>
                                <option value="3" ${m==3?"selected":""}>長期</option>
                            </select>
                        </div>

                        <div class="mt-2 due-date-container" data-task-index="${h}">
                            ${this.renderDueDateField(h,m,p)}
                        </div>
                    </div>

                    <button
                        type="button"
                        class="task-remove-btn text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded flex-shrink-0 transition"
                        data-remove-index="${h}"
                        title="このタスクを削除">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `}).join("");o.innerHTML=c,this.bindTaskSpanChangeEvents(),this.bindTaskRemoveEvents()}renderDueDateField(e,t,s){const r=new Date().toISOString().split("T")[0],o=new Date().getFullYear(),i=Array.from({length:6},(l,c)=>o+c);return t==1?`
                <div>
                    <label class="block text-xs text-gray-600 mb-1">期限（日付）</label>
                    <input type="date"
                        class="task-due-date w-full border rounded px-2 py-1 text-sm"
                        data-task-index="${e}"
                        min="${r}"
                        value="${s}">
                </div>
            `:t==2?`
                <div>
                    <label class="block text-xs text-gray-600 mb-1">期限（年）</label>
                    <select
                        class="task-due-date w-full border rounded px-2 py-1 text-sm pr-8"
                        data-task-index="${e}">
                        <option value="">選択してください</option>
                        ${i.map(l=>`<option value="${l}" ${s==l?"selected":""}>${l}年</option>`).join("")}
                    </select>
                </div>
            `:`
                <div>
                    <label class="block text-xs text-gray-600 mb-1">期限（任意）</label>
                    <input type="text"
                        class="task-due-date w-full border rounded px-2 py-1 text-sm"
                        data-task-index="${e}"
                        placeholder="例：5年後"
                        value="${s}">
                </div>
            `}bindTaskSpanChangeEvents(){document.querySelectorAll(".task-span-select").forEach(t=>{t.addEventListener("change",s=>{const a=parseInt(s.target.getAttribute("data-task-index")),n=parseInt(s.target.value),r=Alpine.store("dashboard");if(r){r.setTaskSpan(a,n);let o="";n==1?o=new Date().toISOString().split("T")[0]:n==2&&(o=new Date().getFullYear().toString());const i=[...r.selectedTaskDueDates];i[a]=o,r.selectedTaskDueDates=i;const l=document.querySelector(`.due-date-container[data-task-index="${a}"]`);l&&(l.innerHTML=this.renderDueDateField(a,n,o),this.bindDueDateChangeEvents())}})}),this.bindDueDateChangeEvents()}bindDueDateChangeEvents(){document.querySelectorAll(".task-due-date").forEach(t=>{t.addEventListener("change",s=>{const a=parseInt(s.target.getAttribute("data-task-index")),n=s.target.value,r=Alpine.store("dashboard");if(r&&r.selectedTaskDueDates){const o=[...r.selectedTaskDueDates];o[a]=n,r.selectedTaskDueDates=o}})})}bindTaskRemoveEvents(){document.querySelectorAll(".task-remove-btn").forEach(t=>{t.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation();const a=parseInt(t.getAttribute("data-remove-index")),n=Alpine.store("dashboard");n&&!isNaN(a)&&(n.removeProposedTask(a),this.renderProposedTasks(n.proposedTasks,n.generatedTag))})})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}showLoading(){this.loadingOverlay&&(this.loadingOverlay.classList.remove("hidden"),this.loadingOverlay.classList.add("flex"))}showLoadingWithMessage(e){if(this.loadingOverlay){const t=document.getElementById("modal-loading-text");t&&e&&(t.textContent=e),this.loadingOverlay.classList.remove("hidden"),this.loadingOverlay.classList.add("flex")}}hideLoading(){if(this.loadingOverlay){this.loadingOverlay.classList.remove("flex"),this.loadingOverlay.classList.add("hidden");const e=document.getElementById("modal-loading-text");if(e){const t=this.isChildTheme;e.textContent=t?"クエストを分解しています...":"AIでタスクを分解しています..."}}}isOpen(){return this.wrapper?.getAttribute("data-modal-state")==="open"}}class T{constructor(){this.showTaskModal=!1,this.showDecompositionModal=!1,this.showRefineModal=!1,this.isProposing=!1,this.taskTitle="",this.taskSpan="",this.refinementPoints="",this.decompositionProposal=null,this.proposedTasks=[],this.selectedTaskSpans={},this.selectedTaskDueDates=[],this.generatedTag=""}reset(){this.showTaskModal=!1,this.showDecompositionModal=!1,this.showRefineModal=!1,this.isProposing=!1,this.taskTitle="",this.refinementPoints="",this.proposedTasks=[],this.selectedTaskSpans={},this.selectedTaskDueDates=[],this.generatedTag=""}}document.addEventListener("alpine:init",()=>{Alpine.store("dashboard",{showTaskModal:!1,showDecompositionModal:!1,showRefineModal:!1,isProposing:!1,taskTitle:"",taskSpan:2,due_date:new Date().getFullYear().toString(),refinementPoints:"",decompositionProposal:null,selectedTags:[],proposedTasks:[],selectedTaskSpans:{},selectedTaskDueDates:[],generatedTag:"",removeProposedTask(d){this.proposedTasks=this.proposedTasks.filter((t,s)=>s!==d);const e={};Object.keys(this.selectedTaskSpans).forEach(t=>{const s=parseInt(t);s<d?e[s]=this.selectedTaskSpans[t]:s>d&&(e[s-1]=this.selectedTaskSpans[t])}),this.selectedTaskSpans=e,this.selectedTaskDueDates=this.selectedTaskDueDates.filter((t,s)=>s!==d)},setTaskSpan(d,e){this.selectedTaskSpans[d]=e,e===1?this.selectedTaskDueDates[d]=new Date().toISOString().split("T")[0]:e===2?this.selectedTaskDueDates[d]=new Date().getFullYear().toString():this.selectedTaskDueDates[d]=""},updateFromController(d){this.showTaskModal=!!d.showTaskModal,this.showDecompositionModal=!!d.showDecompositionModal,this.showRefineModal=!!d.showRefineModal,this.isProposing=!!d.isProposing,this.taskTitle=d.taskTitle||this.taskTitle,this.taskSpan=d.taskSpan||this.taskSpan,this.due_date=d.due_date??this.due_date,this.refinementPoints=d.refinementPoints||this.refinementPoints,this.generatedTag=d.generatedTag??this.generatedTag,d.decompositionProposal!==void 0&&(this.decompositionProposal=d.decompositionProposal),d.selectedTags!==void 0&&(this.selectedTags=[...d.selectedTags||[]]),d.proposedTasks!==void 0&&(this.proposedTasks=[...d.proposedTasks||[]]),d.selectedTaskSpans!==void 0&&(this.selectedTaskSpans={...d.selectedTaskSpans||{}}),d.selectedTaskDueDates!==void 0&&(this.selectedTaskDueDates=[...d.selectedTaskDueDates||[]])}})});class w{constructor(){this.state=new T,this.modal=new b}async decomposeTask(e=!1){let t="",s=2,a=null;const n=document.getElementById("taskTitle"),r=document.getElementById("taskSpan"),o=document.getElementById("refinementPoints");n&&(t=n.value.trim()),r&&(s=parseInt(r.value,10)),e&&o&&(a=o.value.trim());const i=window.Alpine&&Alpine.store?Alpine.store("dashboard"):null;if(!t&&i?.taskTitle&&(t=i.taskTitle.trim()),!s&&i?.taskSpan&&(s=i.taskSpan),e&&!a&&i?.refinementPoints&&(a=i.refinementPoints.trim()),!t&&this.state.taskTitle&&(t=this.state.taskTitle.trim()),!t||t===""){window.showAlertDialog?window.showAlertDialog("タスク名を入力してください。","エラー",()=>{n&&n.focus()}):(alert("タスク名を入力してください。"),n&&n.focus());return}if(e&&(!a||a==="")){window.showAlertDialog?window.showAlertDialog("再提案の観点を入力してください。","エラー",()=>{o&&o.focus()}):(alert("再提案の観点を入力してください。"),o&&o.focus());return}try{this.modal.showLoading(),this.updateState({isProposing:!0});const l=await f.propose(t,s,a,e);let c=l.proposed_tasks||[];if(typeof c=="string")try{c=JSON.parse(c)}catch{c=this._parseTaskList(c)}Array.isArray(c)||(c=[]);const u=c.map((p,g)=>typeof p=="string"?{title:p,originalSpan:s}:p&&typeof p=="object"?{title:p.title||p.name||"",originalSpan:s}:{title:"",originalSpan:s}).filter(p=>p.title.trim()!=="");if(u.length===0){window.showAlertDialog?window.showAlertDialog("タスクの分解に失敗しました。提案されたタスクがありません。","エラー"):alert("タスクの分解に失敗しました。提案されたタスクがありません。"),this.modal.hideLoading(),this.updateState({isProposing:!1});return}const h={};u.forEach((p,g)=>{h[g]=s});const m=Array(u.length).fill("");this.updateState({decompositionProposal:{proposal_id:l.proposal_id,proposed_tasks:l.proposed_tasks,model_used:l.model_used},proposedTasks:u,selectedTaskSpans:h,selectedTaskDueDates:m,generatedTag:t,isProposing:!1}),this.modal.hideLoading(),this.modal.switchView("decomposition")}catch(l){const c=`タスクの分解中にエラーが発生しました。
`+(l.message||"");window.showAlertDialog?window.showAlertDialog(c,"エラー"):alert(c),this.modal.hideLoading(),this.updateState({isProposing:!1})}}_parseTaskList(e){return!e||typeof e!="string"?[]:e.split(/\r?\n/).map(t=>t.trim()).filter(t=>t.length>0).map(t=>{const s=t.match(/^(?:[-*]|\d+\.)\s*(.+)$/);return s?s[1].trim():t}).filter(t=>t.length>0)}async confirmProposal(){const e=window.Alpine&&Alpine.store?Alpine.store("dashboard"):null,t=e?.proposedTasks??this.state.proposedTasks,s=e?.selectedTaskSpans??this.state.selectedTaskSpans,a=e?.selectedTaskDueDates||[];if(console.log("[confirmProposal] Store Data",{proposedTasks:t,selectedTaskSpans:s,dueDates:a,store:e?{selectedTaskDueDates:e.selectedTaskDueDates}:null}),!t||t.length===0)return;if(t.some((r,o)=>!s[o])){window.showAlertDialog?window.showAlertDialog("すべてのタスクにスパンを選択してください。","エラー"):alert("すべてのタスクにスパンを選択してください。");return}try{this.modal.showLoadingWithMessage(this.modal.isChildTheme?"クエストを作成しています...":"タスクを作成しています..."),this.updateState({isProposing:!0});const r=t.map((l,c)=>({title:l.title,span:s[c],due_date:a[c]||null,tags:[e.generatedTag]})),o=e?.decompositionProposal??this.state.decompositionProposal,i=await f.adopt(o.proposal_id??o.id,r);if(console.log("[confirmProposal] Response received",i),i.success)this.showToast(i.message,"success"),i.avatar_comment&&typeof window.showAvatarComment=="function"&&(console.log("[confirmProposal] Showing avatar comment:",i.avatar_comment),window.showAvatarComment(i.avatar_comment)),this.updateState({showDecompositionModal:!1,decompositionProposal:null,proposedTasks:[],selectedTaskSpans:{},selectedTaskDueDates:[],generatedTag:"",isProposing:!1}),this.modal.close(),this.modal.hideLoading(),i.html&&this.updateTaskListWithHTML(i.html);else throw new Error(i.message||"タスクの作成に失敗しました。")}catch(r){this.modal.hideLoading(),this.updateState({isProposing:!1}),this.showToast(r.message||"タスクの作成中にエラーが発生しました","error"),console.error("[confirmProposal] Error:",r)}}showToast(e,t="success"){console.log("[showToast]",{message:e,type:t});const s=document.getElementById("dynamic-toast");s&&s.remove();const a=document.createElement("div");a.id="dynamic-toast",a.className="fixed top-4 right-4 z-50 max-w-sm w-full",a.setAttribute("role","alert"),a.setAttribute("aria-live","assertive"),a.setAttribute("aria-atomic","true");const n={success:{bg:"bg-green-50",border:"border-green-500",text:"text-green-800",icon:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"},error:{bg:"bg-red-50",border:"border-red-500",text:"text-red-800",icon:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"},warning:{bg:"bg-yellow-50",border:"border-yellow-500",text:"text-yellow-800",icon:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"},info:{bg:"bg-blue-50",border:"border-blue-500",text:"text-blue-800",icon:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"}},r=n[t]||n.success;a.innerHTML=`
            <div class="flex items-start p-4 rounded-lg shadow-lg border-l-4 ${r.bg} ${r.border} ${r.text}">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${r.icon}" />
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-sm font-medium">${this.escapeHtml(e)}</p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button class="toast-close inline-flex rounded-md hover:opacity-75">
                        <span class="sr-only">閉じる</span>
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        `,document.body.appendChild(a),requestAnimationFrame(()=>{a.style.opacity="0",a.style.transform="translateY(8px)",a.style.transition="opacity 300ms ease-out, transform 300ms ease-out",requestAnimationFrame(()=>{a.style.opacity="1",a.style.transform="translateY(0)"})});const o=a.querySelector(".toast-close"),i=()=>{a.style.opacity="0",a.style.transform="translateY(8px)",setTimeout(()=>a.remove(),200)};o&&o.addEventListener("click",i),setTimeout(i,5e3)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}updateTaskListWithHTML(e){const t=document.querySelector("#task-list-container");if(!t){console.error("[updateTaskListWithHTML] Task list container not found");return}t.innerHTML=e,window.Alpine&&Alpine.initTree(t),console.log("[updateTaskListWithHTML] Task list updated with server-rendered HTML")}updateTaskList(e,t){if(!e||e.length===0)return;if((Alpine.store?.("dashboard")?.activeTab||"todo")!=="todo"){console.log("[updateTaskList] Not on todo tab, skipping update");return}let n=null;const r=document.querySelectorAll("[data-bucket-name]");for(const l of r)if(l.getAttribute("data-bucket-name")===t){n=l;break}if(!n){this.createNewBucket(t,e);return}const o=n.querySelector(".task-list-container");if(!o){console.warn("[updateTaskList] Task list container not found");return}const i=o.querySelector(".empty-state");i&&i.remove(),e.forEach(l=>{const c=this.createTaskCard(l);o.insertAdjacentHTML("beforeend",c)})}createNewBucket(e,t){const s=t.map(i=>this.createTaskCard(i)).join(""),a=`
            <div class="bento-card group relative rounded-2xl shadow-lg hover:shadow-2xl p-6 cursor-pointer" data-bucket-name="${this.escapeHtml(e)}">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#59B9C6] to-[#3b82f6] flex items-center justify-center shadow-lg">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-900 dark:text-white">${this.escapeHtml(e)}</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${t.length}件のタスク</p>
                        </div>
                    </div>
                </div>
                <div class="task-list-container space-y-3">
                    ${s}
                </div>
            </div>
        `,n=document.querySelector(`[x-show="activeTab === 'todo'"]`);if(!n){console.warn("[createNewBucket] Todo tab container not found");return}const r=n.querySelector(".empty-state");r&&r.remove();let o=n.querySelector(".bento-grid");o||(o=document.createElement("div"),o.className="bento-grid grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6",n.appendChild(o)),o.insertAdjacentHTML("afterbegin",a)}createTaskCard(e){const t={1:"短期",2:"中期",3:"長期"},s={1:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",2:"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300",3:"bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-300"},a=t[e.span]||"中期",n=s[e.span]||s[2],r=e.due_date?`<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">期限: ${this.escapeHtml(e.due_date)}</p>`:"";return`
            <div class="task-card group bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2 break-words">${this.escapeHtml(e.title)}</h4>
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${n}">
                                ${a}
                            </span>
                        </div>
                        ${r}
                    </div>
                    <div class="flex items-center gap-1">
                        <form method="POST" action="/tasks/${e.id}/toggle" class="inline">
                            <input type="hidden" name="_token" value="${document.querySelector('meta[name="csrf-token"]')?.content}">
                            <input type="hidden" name="_method" value="PATCH">
                            <button type="submit" class="task-toggle-btn p-2 rounded-lg text-gray-400 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 transition" title="完了にする">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        `}updateState(e){Object.assign(this.state,e),window.Alpine&&Alpine.store&&Alpine.store("dashboard")&&Alpine.store("dashboard").updateFromController(this.state)}}class v{constructor(e){this.dashboard=e,this.boundHandlers=new Map,this.initialized=!1}init(){this.initialized||(this.initialized=!0,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.#t()}):this.#t())}#t(){this.#e("open-task-modal-btn",()=>{this.dashboard.modal.open()}),this.#e("close-modal-btn",()=>{this.dashboard.modal.close()});const e=document.getElementById("task-modal-wrapper");if(e){const i=l=>{l.target===e&&this.dashboard.modal.close()};e.addEventListener("click",i),this.boundHandlers.set("task-modal-wrapper-click",i)}const t=i=>{i.key==="Escape"&&this.dashboard.modal.isOpen()&&this.dashboard.modal.close()};document.addEventListener("keydown",t),this.boundHandlers.set("escape-key",t);const s=document.getElementById("taskTitle");if(s){const i=l=>{const c=Alpine.store?.("dashboard");c&&(c.taskTitle=l.target.value),this.dashboard.state.taskTitle=l.target.value,this.dashboard.modal.updateButtonStates()};s.addEventListener("input",i),this.boundHandlers.set("taskTitle-input",i)}const a=document.getElementById("taskSpan");if(a){const i=l=>{const c=parseInt(l.target.value,10);console.log("[spanHandler] Span changed to:",c);const u=Alpine.store?.("dashboard");u&&(u.taskSpan=c),this.dashboard.state.taskSpan=c,this.dashboard.modal.switchDueDateField(c)};a.addEventListener("change",i),this.boundHandlers.set("taskSpan-change",i)}document.querySelectorAll(".tag-checkbox").forEach(i=>{i.addEventListener("change",l=>{const c=l.target.closest(".task-tag-chip");c&&this.dashboard.modal.updateTagChipStyle(c,l.target.checked);const u=Alpine.store?.("dashboard");if(u){const h=parseInt(l.target.value);l.target.checked?u.selectedTags.includes(h)||(u.selectedTags=[...u.selectedTags,h]):u.selectedTags=u.selectedTags.filter(m=>m!==h)}})});const r=document.getElementById("refinementPoints");if(r){const i=l=>{const c=Alpine.store?.("dashboard");c&&(c.refinementPoints=l.target.value),this.dashboard.state.refinementPoints=l.target.value,this.updateRefineButtonState()};r.addEventListener("input",i),this.boundHandlers.set("refinementPoints-input",i)}this.#e("decompose-btn",()=>{this.dashboard.decomposeTask(!1)}),this.#e("adopt-proposal-btn",()=>{this.dashboard.confirmProposal()}),this.#e("cancel-decomposition-btn",()=>{this.dashboard.modal.switchView("input")}),this.#e("refine-proposal-btn",()=>{this.dashboard.modal.switchView("refine")}),this.#e("cancel-refine-btn",()=>{this.dashboard.modal.switchView("decomposition")}),this.#e("submit-refine-btn",()=>{this.dashboard.decomposeTask(!0)});const o=document.getElementById("simple-register-btn");if(o){const i=l=>{const c=document.getElementById("task-form");if(c&&!c.checkValidity()){c.reportValidity(),l.preventDefault();return}};o.addEventListener("click",i,{once:!1})}}#e(e,t){if(this.boundHandlers.has(e))return;const s=document.getElementById(e);if(!s)return;const a=n=>{n?.preventDefault?.(),n?.stopPropagation?.(),t.call(this,n)};s.addEventListener("click",a,{once:!1}),this.boundHandlers.set(e,a)}updateRefineButtonState(){const e=document.getElementById("submit-refine-btn");if(!e)return;const s=document.getElementById("refinementPoints")?.value.trim().length>0;e.disabled=!s}destroy(){this.boundHandlers.forEach((e,t)=>{if(t==="escape-key")document.removeEventListener("keydown",e);else if(t==="task-modal-wrapper-click"){const s=document.getElementById("task-modal-wrapper");s&&s.removeEventListener("click",e)}else if(t==="taskSpan-change"){const s=document.getElementById("taskSpan");s&&s.removeEventListener("change",e)}else if(t==="taskTitle-input"){const s=document.getElementById("taskTitle");s&&s.removeEventListener("input",e)}else if(t==="refinementPoints-input"){const s=document.getElementById("refinementPoints");s&&s.removeEventListener("input",e)}else{const s=document.getElementById(t);s&&s.removeEventListener("click",e)}}),this.boundHandlers.clear(),this.initialized=!1}}let k=!1;document.addEventListener("alpine:init",()=>{if(k)return;k=!0;const d=new w,e=new v(d);window.dashboard=d,window.decomposeTask=(...t)=>d.decomposeTask(...t),window.acceptProposal=()=>d.confirmProposal(),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{e.init()}):e.init(),Alpine.store("toast",{visible:!1,message:"",type:"success",timer:null,show(t,s="success"){this.message=t,this.type=s,this.visible=!0,this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.hide()},5e3)},hide(){this.visible=!1,this.timer&&(clearTimeout(this.timer),this.timer=null)}})});
