class c{constructor(){this.searchInput=null,this.resultsContainer=null,this.searchTimeout=null,this.currentFocusIndex=-1,this.searchResults=[],this.currentTerms=[],this.currentOperator="or"}init(){if(this.searchInput=document.querySelector("#notification-search-input"),!this.searchInput){console.warn("Notification search input not found");return}this.createResultsContainer(),this.setupEventListeners()}createResultsContainer(){this.resultsContainer=document.createElement("div"),this.resultsContainer.id="notification-search-results",this.resultsContainer.className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 hidden max-h-96 overflow-y-auto";const e=this.searchInput.closest(".relative");e&&e.appendChild(this.resultsContainer)}setupEventListeners(){this.searchInput.addEventListener("input",e=>{if(clearTimeout(this.searchTimeout),e.target.value.trim()===""){this.hideResults();return}this.searchTimeout=setTimeout(()=>{this.performSearch(e.target.value)},300)}),this.searchInput.addEventListener("keydown",e=>{if(!this.resultsContainer.classList.contains("hidden"))switch(e.key){case"ArrowDown":e.preventDefault(),this.focusNext();break;case"ArrowUp":e.preventDefault(),this.focusPrevious();break;case"Enter":e.preventDefault(),this.selectCurrent();break;case"Escape":this.hideResults();break}}),document.addEventListener("click",e=>{!this.searchInput.contains(e.target)&&!this.resultsContainer.contains(e.target)&&this.hideResults()})}async performSearch(e){try{const t=this.parseSearchQuery(e);this.currentTerms=t.terms,this.currentOperator=t.operator;const s=await this.searchNotifications(t);this.searchResults=s.notifications||[],this.displayResults(this.searchResults)}catch(t){console.error("Search error:",t),this.showError("検索中にエラーが発生しました")}}parseSearchQuery(e){const t={terms:[],operator:"or"};return e.includes("&")?(t.operator="and",t.terms=e.split("&").map(s=>s.trim()).filter(s=>s)):(t.operator="or",t.terms=e.split(/\s+/).filter(s=>s)),t}async searchNotifications(e){const t=new URL("/notification/search/api",window.location.origin);t.searchParams.append("operator",e.operator),e.terms.forEach(a=>t.searchParams.append("terms[]",a));const s=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),r={Accept:"application/json","X-Requested-With":"XMLHttpRequest"};s&&(r["X-CSRF-TOKEN"]=s);const n=await fetch(t,{method:"GET",headers:r,credentials:"include"});if(!n.ok)throw new Error(`Search failed: ${n.status}`);return n.json()}displayResults(e){if(this.currentFocusIndex=-1,!e||e.length===0){this.resultsContainer.innerHTML='<div class="p-4 text-gray-500 dark:text-gray-400 text-center">検索結果は0件でした</div>',this.resultsContainer.classList.remove("hidden");return}const t=e.map((r,n)=>{const a=this.getPriorityBadge(r.priority),o=this.getSourceBadge(r.source,r.source_label),l=r.is_read?"":'<span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-400">未読</span>';return`
                <div class="search-result-item p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-b-0 transition ${r.is_read?"opacity-60":""}" 
                     data-index="${n}"
                     data-notification-id="${r.id}"
                     tabindex="0">
                    <div class="flex items-center gap-2 mb-2">
                        ${a}
                        ${o}
                        ${l}
                    </div>
                    <div class="font-medium text-gray-900 dark:text-white mb-1">${this.escapeHtml(r.title)}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <span>${r.sender}</span>
                        <span class="mx-2">•</span>
                        <span>${r.publish_at||"日時不明"}</span>
                    </div>
                </div>
            `}).join(""),s=`
            <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                <button 
                    id="view-all-results-btn"
                    class="w-full py-2 px-4 bg-[#59B9C6] hover:bg-[#4a9fb0] text-white font-medium rounded-lg transition-colors">
                    すべての検索結果を表示
                </button>
            </div>
        `;this.resultsContainer.innerHTML=t+s,this.resultsContainer.classList.remove("hidden"),this.resultsContainer.querySelectorAll(".search-result-item").forEach(r=>{r.addEventListener("click",()=>{const n=r.dataset.notificationId;window.location.href=`/notification/${n}`}),r.addEventListener("keydown",n=>{if(n.key==="Enter"){n.preventDefault();const a=r.dataset.notificationId;window.location.href=`/notification/${a}`}})}),document.getElementById("view-all-results-btn")?.addEventListener("click",()=>{this.navigateToSearchResults()})}navigateToSearchResults(){const e=new URL("/notification/search/results",window.location.origin);e.searchParams.append("operator",this.currentOperator),this.currentTerms.forEach(t=>e.searchParams.append("terms[]",t)),window.location.href=e.toString()}getPriorityBadge(e){return e==="important"?'<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-400">重要</span>':e==="normal"?'<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-400">通常</span>':'<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-400">情報</span>'}getSourceBadge(e,t){return e==="admin"?'<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-400">公式</span>':'<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400">システム</span>'}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}showError(e){this.resultsContainer.innerHTML=`<div class="p-4 text-red-500 dark:text-red-400 text-center">${e}</div>`,this.resultsContainer.classList.remove("hidden")}hideResults(){this.resultsContainer.classList.add("hidden"),this.currentFocusIndex=-1}focusNext(){const e=this.resultsContainer.querySelectorAll(".search-result-item");e.length!==0&&(this.currentFocusIndex=(this.currentFocusIndex+1)%e.length,this.updateFocus(e))}focusPrevious(){const e=this.resultsContainer.querySelectorAll(".search-result-item");e.length!==0&&(this.currentFocusIndex=this.currentFocusIndex<=0?e.length-1:this.currentFocusIndex-1,this.updateFocus(e))}updateFocus(e){e.forEach((t,s)=>{s===this.currentFocusIndex?(t.classList.add("bg-gray-100","dark:bg-gray-700"),t.scrollIntoView({block:"nearest"}),t.focus()):t.classList.remove("bg-gray-100","dark:bg-gray-700")})}selectCurrent(){const e=this.resultsContainer.querySelectorAll(".search-result-item");if(this.currentFocusIndex>=0&&this.currentFocusIndex<e.length){const t=e[this.currentFocusIndex].dataset.notificationId;window.location.href=`/notification/${t}`}}}document.addEventListener("DOMContentLoaded",()=>{new c().init()});
