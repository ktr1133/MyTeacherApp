# タスク一覧画面 要件定義書

## 更新履歴

| 日付 | 更新者 | 更新内容 |
|------|--------|---------|
| 2025-12-09 | GitHub Copilot | IndexTaskApiActionのデフォルトstatus変更（'all'→'pending'）を反映、Web/Mobile整合性確保 |
| 2025-12-07 | GitHub Copilot | 初版作成: Phase 2.B-5 Step 1 完了後の質疑応答結果を要件化 |
| 2025-12-07 | GitHub Copilot | 画像機能に関する追記（画像アップロード機能は実装済み、IndexTaskApiAction修正） |
| 2025-12-07 | GitHub Copilot | タスク一覧画面に関連しない項目を削除（通知機能、テスト修正は別ファイルに記載） |

---

## 1. 概要

MyTeacherモバイルアプリのタスク一覧画面（TaskListScreen）の機能要件を定義します。本画面は未完了タスクの表示、検索機能、タスク詳細への遷移を提供します。

### 1.1 対応フェーズ

- **Phase 2.B-5 Step 1**: タスク一覧画面基本実装（2025-12-06～2025-12-07完了）

### 1.2 関連画面

- **Webアプリ**: ダッシュボード（Bentoレイアウト）、タスク一覧
- **モバイルアプリ**: TaskListScreen、TaskDetailScreen、TaskEditScreen、CreateTaskScreen

---

## 2. 画面仕様

### 2.1 画面構成

```
┌─────────────────────────────────────┐
│ ヘッダー                             │
│ ┌─────────────┐                     │
│ │ タスク一覧   │          [+]        │
│ └─────────────┘                     │
├─────────────────────────────────────┤
│ 検索バー                             │
│ ┌─────────────────────────────┐     │
│ │ 🔍 タスクを検索...         [✕]│     │
│ └─────────────────────────────┘     │
├─────────────────────────────────────┤
│ 検索結果件数（検索時のみ表示）         │
│ 5件のタスクが見つかりました           │
├─────────────────────────────────────┤
│ タスクカード一覧                      │
│ ┌─────────────────────────────┐     │
│ │ [タイトル]                   │     │
│ │ [説明文（2行まで）]           │     │
│ │ [タグ1] [タグ2]              │     │
│ │ 報酬: 100トークン  期限: 12/31│     │
│ │ [完了にする]                  │     │
│ └─────────────────────────────┘     │
│ ┌─────────────────────────────┐     │
│ │ （次のタスクカード）           │     │
│ └─────────────────────────────┘     │
└─────────────────────────────────────┘
```

### 2.2 表示要素

#### 2.2.1 ヘッダー

| 要素 | 仕様 |
|------|------|
| タイトル | テーマ別: 「やること」（子ども）/ 「タスク一覧」（大人） |
| 作成ボタン | 右上の [+] ボタン、タスク作成画面へ遷移 |

#### 2.2.2 検索バー

| 要素 | 仕様 |
|------|------|
| プレースホルダー | 「タスクを検索（タイトル・説明・タグ）」 |
| クリアボタン | 検索文字列入力時に [✕] ボタン表示、タップで検索クリア |
| 検索対象 | タイトル、説明、タグ名（部分一致） |
| 検索方式 | フロントエンド側フィルタリング（取得済みタスクを即座にフィルター） |
| 検索結果件数表示 | 検索時のみ表示: 「5件のタスクが見つかりました」 |

#### 2.2.3 タスクカード

| 要素 | 仕様 | 表示条件 |
|------|------|---------|
| タイトル | タスク名、完了済みは取り消し線 | 必須 |
| 説明 | 説明文（2行まで表示） | 存在する場合 |
| タグ | タグバッジ（紫色、丸み）、複数タグ対応 | 存在する場合 |
| 報酬 | 「⭐100」（子ども）/ 「報酬: 100トークン」（大人） | **グループタスクのみ** |
| 期限 | 「⏰ 12/31」（子ども）/ 「期限: 12/31」（大人） | 存在する場合 |
| 完了ボタン | 「できた!」（子ども）/ 「完了にする」（大人） | 未完了タスクのみ |

### 2.3 データ取得仕様

#### 2.3.1 API仕様

| 項目 | 仕様 |
|------|------|
| エンドポイント | `GET /api/tasks?status=pending` |
| パラメータ | `status=pending`（未完了のみ） |
| デフォルト動作 | パラメータ省略時も`status=pending`が適用される（2025-12-09変更） |
| ページネーション | 20件/ページ（デフォルト） |
| レスポンス | Task[]（is_completed, completed_at, tags配列） |

**重要**: 2025-12-09に`IndexTaskApiAction`のデフォルト値を`'all'`から`'pending'`に変更し、WebアプリとモバイルアプリでAPI動作を統一しました。これにより、`status`パラメータを省略した場合でも未完了タスクのみが返却されます。

#### 2.3.2 取得データ項目

| 項目 | 型 | 説明 |
|------|-----|------|
| id | number | タスクID |
| title | string | タスク名 |
| description | string \| null | 説明文 |
| is_completed | boolean | 完了状態 |
| completed_at | string \| null | 完了日時（ISO 8601） |
| reward | number | 報酬トークン |
| is_group_task | boolean | グループタスクフラグ |
| due_date | string \| null | 期限（YYYY-MM-DD） |
| tags | TaskTag[] | タグ配列（id + name） |
| images | TaskImage[] | 画像配列（id + path + url） |

**TaskImage型**:
```typescript
{
  id: number;
  path: string;      // S3/MinIOパス（例: task_approvals/xxx.jpg）
  url: string;       // 公開URL
}
```

**注意**: 画像アップロード機能は実装済み（TaskDetailScreen）。一覧画面では画像は表示せず、詳細画面で表示。

---

## 3. 機能要件

### 3.1 未完了タスクのみ表示

#### 3.1.1 要件

- **表示対象**: `is_completed = false` のタスクのみ
- **理由**: データ量削減、UX向上（Webアプリと同様）
- **実装方式**: API呼び出し時に `status=pending` パラメータ指定

#### 3.1.2 除外機能

- ❌ **完了/未完了切り替えボタン**: 不要（Webアプリと異なる）
- ❌ **「すべて」フィルター**: 不要

### 3.2 検索機能

#### 3.2.1 検索仕様

| 項目 | 仕様 |
|------|------|
| 検索方式 | フロントエンド側フィルタリング |
| 検索対象 | タイトル、説明、タグ名 |
| 検索タイプ | 部分一致（大文字小文字区別なし） |
| 即時反映 | 入力と同時にフィルタリング実行 |

#### 3.2.2 検索結果表示

- **件数表示**: 「5件のタスクが見つかりました」（検索時のみ）
- **0件時**: 「やることがないよ」（子ども）/ 「タスクがありません」（大人）

#### 3.2.3 バックエンド検索API（未実装）

- **現在**: フロントエンド側フィルタリング（取得済み20件内）
- **将来**: `/api/tasks?q={query}` によるサーバー側検索（大量タスク対応時）
- **実装時期**: 大量タスクが発生した場合に検討

### 3.3 タグ表示

#### 3.3.1 表示仕様

| 項目 | 仕様 |
|------|------|
| 表示形式 | タグバッジ（紫色背景、白文字、丸み） |
| 複数タグ | 横並び、折り返しあり |
| データ構造 | `{id: number, name: string}[]` |

#### 3.3.2 タグフィルター機能（未実装）

- **要件**: タグ選択によるタスク絞り込み
- **実装方式**: Option B（フラットリスト + タグフィルター）
- **実装時期**: Phase 2.B-5 Step 3以降

### 3.4 報酬表示

#### 3.4.1 表示条件

- **表示対象**: グループタスク（`is_group_task = true`）のみ
- **非表示**: 個人タスク（`is_group_task = false`）

#### 3.4.2 表示形式

- **子どもテーマ**: 「⭐100」
- **大人テーマ**: 「報酬: 100トークン」

### 3.5 タスク詳細遷移

#### 3.5.1 遷移仕様

| 項目 | 仕様 |
|------|------|
| トリガー | タスクカードタップ |
| 遷移先 | グループタスク: TaskDetailScreen（閲覧のみ）<br>通常タスク: TaskEditScreen（編集可能） |
| パラメータ | `{taskId: number}` |
| ナビゲーション | Stack Navigator |

#### 3.5.2 遷移ロジック

```typescript
const navigateToDetail = useCallback(
  (taskId: number) => {
    const task = tasks.find(t => t.id === taskId);
    if (task?.is_group_task) {
      // グループタスク → 詳細画面（編集不可）
      navigation.navigate('TaskDetail', { taskId });
    } else {
      // 通常タスク → 編集画面
      navigation.navigate('TaskEdit', { taskId });
    }
  },
  [tasks, navigation]
);
```

---

## 4. UI/UXガイドライン

### 4.1 テーマ対応

#### 4.1.1 子どもテーマ

| 要素 | 仕様 |
|------|------|
| 文言 | ひらがな中心、親しみやすい表現 |
| アイコン | 絵文字使用（⭐、⏰） |
| 色 | 明るい色、丸みのあるデザイン |

**例**:
- タイトル: 「やること」
- 検索: 「さがす」
- 報酬: 「⭐100」
- 期限: 「⏰ 12/31」
- 完了ボタン: 「できた!」

#### 4.1.2 大人テーマ

| 要素 | 仕様 |
|------|------|
| 文言 | 漢字・ビジネス用語 |
| アイコン | シンプルなアイコン |
| 色 | 落ち着いた色、シャープなデザイン |

**例**:
- タイトル: 「タスク一覧」
- 検索: 「タスクを検索」
- 報酬: 「報酬: 100トークン」
- 期限: 「期限: 12/31」
- 完了ボタン: 「完了にする」

### 4.2 レスポンシブ対応

- **リスト表示**: FlatList使用、スクロール最適化
- **タップ領域**: 最小44x44pt（iOS Human Interface Guidelines準拠）

---

## 5. データベーススキーマ対応

### 5.1 使用テーブル

#### 5.1.1 tasksテーブル

| カラム名 | 型 | 説明 | 使用箇所 |
|---------|-----|------|---------|
| id | integer | タスクID | 一覧表示、詳細遷移 |
| title | string | タスク名 | タスクカード |
| description | text | 説明 | タスクカード |
| is_completed | boolean | 完了状態 | フィルター条件 |
| completed_at | timestamp | 完了日時 | レスポンス |
| reward | integer | 報酬 | グループタスク表示 |
| is_group_task | boolean | グループタスクフラグ | 報酬表示条件 |
| due_date | string | 期限 | タスクカード |
| group_task_id | uuid | グループID | グループタスク判定 |

**注意**: `status`カラムは存在しない（`is_completed`を使用）

#### 5.1.2 tagsテーブル（リレーション）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | integer | タグID |
| name | string | タグ名 |

**リレーション**: `tasks.tags` → `TaskTag[]`（id + name）

---

## 6. エラーハンドリング

### 6.1 エラーパターン

| エラー種別 | 原因 | 対応 |
|-----------|------|------|
| ネットワークエラー | 通信失敗 | アラート表示、リトライ可能 |
| 401エラー | 認証切れ | 自動ログアウト → ログイン画面遷移 |
| 500エラー | サーバーエラー | アラート表示、技術サポート誘導 |
| タスク0件 | データなし | 空状態表示（作成ボタン誘導） |

### 6.2 エラーメッセージ

| テーマ | メッセージ |
|-------|-----------|
| 子ども | 「エラーがおきちゃった！もういちどためしてね」 |
| 大人 | 「通信エラーが発生しました。再度お試しください。」 |

---

## 7. パフォーマンス要件

### 7.1 応答時間

| 項目 | 目標 |
|------|------|
| API取得 | 2秒以内 |
| 検索フィルター | 即座（同期処理） |
| 画面遷移 | 0.3秒以内 |

### 7.2 最適化

- **FlatList最適化**: `keyExtractor`, `getItemLayout`使用
- **メモ化**: `useMemo`, `useCallback`使用
- **画像遅延読み込み**: 将来対応（タスク画像表示時）

---

## 8. テスト要件

### 8.1 単体テスト

- [x] タスク取得成功時、未完了タスクのみ表示
- [x] 検索入力時、タイトル・説明・タグで部分一致フィルタリング
- [x] グループタスクのみ報酬表示
- [x] タグが正しく表示（id + name）
- [x] 完了ボタンタップで完了API呼び出し
- [x] グループタスクはTaskDetailScreen、通常タスクはTaskEditScreenに遷移

### 8.2 統合テスト

- [x] タスクカードタップで適切な画面に遷移
- [x] 検索結果件数が正しく表示
- [x] 0件時に空状態表示
- [x] 画面フォーカス時にタスクリストを再同期

### 8.3 E2Eテスト（Phase 2.B-8）

- [ ] ログイン → タスク一覧表示 → 検索 → 詳細遷移

### 8.4 テスト実行結果（2025-12-07）

**モバイルアプリテスト**: 203 tests passing (14 test suites)
- TaskListScreen: 11 tests passing
- useTasks Hook: 7 tests passing
- task.service: 9 tests passing

**Laravelテスト**: 442 tests passing, 18 skipped
- IndexTaskApiAction: タスク一覧取得API正常動作

---

## 9. 実装ファイル

### 9.1 実装ファイル一覧

| ファイルパス | 説明 | 行数 | 状態 |
|------------|------|------|------|
| `/home/ktr/mtdev/mobile/src/screens/tasks/TaskListScreen.tsx` | タスク一覧画面 | 575行 | ✅ 実装完了 |
| `/home/ktr/mtdev/mobile/src/hooks/useTasks.ts` | タスク管理Hook | 465行 | ✅ 実装完了 |
| `/home/ktr/mtdev/mobile/src/services/task.service.ts` | タスクAPI通信 | 390行 | ✅ 実装完了 |
| `/home/ktr/mtdev/mobile/src/types/task.types.ts` | タスク型定義 | 133行 | ✅ 実装完了 |
| `/home/ktr/mtdev/app/Http/Actions/Api/Task/IndexTaskApiAction.php` | バックエンドAPI | 116行 | ✅ 実装完了 |

### 9.2 テストファイル

| ファイルパス | テスト数 | 状態 |
|------------|---------|------|
| `/__tests__/services/task.service.test.ts` | 9テスト | ✅ 全件合格 |
| `/__tests__/hooks/useTasks.test.tsx` | 7テスト | ✅ 全件合格 |
| `/__tests__/screens/TaskListScreen.test.tsx` | 11テスト | ✅ 全件合格 |

### 9.3 主要実装詳細

#### 9.3.1 画面フォーカス時の再同期

**実装場所**: TaskListScreen.tsx 73-80行目

```typescript
useFocusEffect(
  useCallback(() => {
    // 画面がフォーカスされたら、未完了タスクを再取得
    fetchTasks({ status: 'pending' });
  }, [fetchTasks])
);
```

**目的**: タスク削除後に前画面に戻った際、削除されたタスクを即座に消すため

#### 9.3.2 検索フィルタリング

**実装場所**: TaskListScreen.tsx 86-106行目

```typescript
useEffect(() => {
  if (searchQuery.trim()) {
    // 検索クエリがある場合: タイトル、説明、タグ名で部分一致フィルタリング
    const query = searchQuery.toLowerCase();
    const filtered = tasks.filter(task => {
      if (task.title?.toLowerCase().includes(query)) return true;
      if (task.description?.toLowerCase().includes(query)) return true;
      if (task.tags?.some(tag => tag.name?.toLowerCase().includes(query))) return true;
      return false;
    });
    setFilteredTasks(filtered);
  } else {
    setFilteredTasks(tasks);
  }
}, [tasks, searchQuery]);
```

**特徴**: フロントエンド側フィルタリング（即座に反応）

---

## 10. 将来対応

### 10.1 Phase 2.B-5 Step 3以降

- **タスク編集機能強化**: タイトル、説明、タグ、期限の編集
- **タスク削除機能**: 確認ダイアログ付き削除
- **タグフィルター機能**: タグ選択によるタスク絞り込み
- **複数タグ選択**: AND/OR条件指定
- **タグ管理**: タグ作成・編集・削除

### 10.2 Phase 2.B-6

- **バケツ表示（Bentoレイアウト）**: タグごとのグループ化表示（Web版整合性）
- **ページネーション**: 無限スクロール対応
- **バックエンド検索API**: `/api/tasks?q={query}` 実装（大量タスク対応）

---

## 11. Webアプリとの差分

### 11.1 実装済み機能（モバイル版）

- ✅ 未完了タスク表示
- ✅ 検索機能（フロントエンド側フィルタリング）
- ✅ タグ表示（id + name）
- ✅ グループタスクのみ報酬表示
- ✅ タスク詳細遷移（グループタスク: 詳細画面、通常タスク: 編集画面）
- ✅ 画面フォーカス時の自動再同期
- ✅ Pull-to-Refresh機能
- ✅ 完了ボタンによるタスク完了

### 11.2 未実装機能（将来対応）

- ❌ **バケツ表示（Bentoレイアウト）**: タグごとのグループカード表示（Phase 2.B-6）
- ❌ **タグフィルター**: タグ選択による絞り込み（Phase 2.B-5 Step 3）
- ❌ **完了/未完了切り替え**: モバイル版は未完了のみ表示（Webと異なる仕様）
- ❌ **一括操作**: 複数タスク選択・一括完了（Phase 2.B-6）

### 11.3 モバイル独自機能

- 現時点ではなし

---

## 12. 参考資料

### 12.1 関連ドキュメント

- `/home/ktr/mtdev/docs/plans/phase2-mobile-app-implementation-plan.md`
- `/home/ktr/mtdev/docs/mobile/mobile-rules.md`
- `/home/ktr/mtdev/.github/copilot-instructions.md`
- `/home/ktr/mtdev/definitions/Task.md`（Webアプリ要件）

### 12.2 完了レポート

- `/home/ktr/mtdev/docs/reports/mobile/2025-12-07-phase2-b5-step1-task-list-completion-report.md`

---

## 13. 質疑応答履歴

### Q1: 検索機能の挙動について

**質問**: 検索はどういう挙動になりますか？一覧画面に存在するタスクの件名の一部を入力しても何も反応はありません。

**回答**: 
- **原因**: バックエンド側で検索APIが未実装
- **対応**: フロントエンド側フィルタリングに変更（取得済みタスクを即座にフィルター）
- **実装**: TaskListScreen.tsx 73-93行目

### Q2: 報酬表示について

**質問**: グループタスクではないのに報酬の表示は不要です。グループタスクの場合のみ表示するようにしてください。

**回答**:
- **修正前**: すべてのタスクで報酬表示
- **修正後**: `is_group_task === true` のタスクのみ報酬表示
- **実装**: TaskListScreen.tsx 194-199行目

### Q3: タグ表示について

**質問**: タグが「不明」となっています。（webアプリでは「すべての画面のレスポンシブUIを改善する作業」のタグがついています）

**回答**:
- **原因**: `item.tags`の参照方法が間違っていた
- **修正**: `task.tags.map(tag => tag.name)` で正しく表示
- **実装**: TaskListScreen.tsx 191-197行目（タグバッジ表示）

### Q4: ステータスフィルターについて

**質問**: 完了、未完了が選択できる状態です。未完了のみ表示するようにしてください（webアプリでは画面に呼び出すデータを減らす目的で未完了のみ表示するようにしています。）

**回答**:
- **修正前**: `selectedStatus = 'all'` → 完了・未完了両方表示
- **修正後**: `selectedStatus = 'pending'` → 未完了のみ表示
- **UI変更**: ステータス切り替えボタン削除
- **実装**: TaskListScreen.tsx 53行目

### Q5: バケツ表示（Bentoレイアウト）について

**質問**: タスクのバケツ表示方法についての進捗はいかがですか？

**回答**:
- **Option A**: Webと同じバケツレイアウト（複雑、スクロール操作難）
- **Option B**: タスクをフラットリスト表示 + タグでフィルター（モバイル推奨） ← **採用**
- **実装時期**: Phase 2.B-5 Step 3以降（タグフィルター機能）

### Q6: 検索機能のバックエンド実装について

**質問**: 検索機能はバックエンド側で未実装であるため、これも後ろ倒しでの対応ということでOKですか？

**回答**:
- **現在**: フロントエンド側フィルタリング（取得済み20件内）で**実装済み**
- **バックエンドAPI**: 大量タスクが発生した場合に検討
- **結論**: 検索機能は実装済み・動作中、後ろ倒し不要

---

## 14. 承認

| 承認項目 | 承認者 | 承認日 | 備考 |
|---------|--------|--------|------|
| 要件定義承認 | - | 2025-12-07 | Phase 2.B-5 Step 1完了時点 |
| 実装完了承認 | - | 2025-12-07 | 実機テスト完了 |

---

**作成日**: 2025-12-07  
**最終更新日**: 2025-12-07  
**レビュー**: 未実施  
**バージョン**: 1.4
