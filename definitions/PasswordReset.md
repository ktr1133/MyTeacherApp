# パスワードリセット機能 要件定義書

## 更新履歴

| 日付 | 更新者 | 更新内容 |
|------|--------|---------|
| 2025-12-13 | GitHub Copilot | 初版作成: パスワードリセット機能要件定義 |

---

## 1. 概要

MyTeacherアプリケーション（Web版・モバイル版）にパスワードリセット機能を実装。ユーザーがパスワードを忘れた場合に、メールアドレスを入力することでパスワードリセット用のリンクを受け取り、新しいパスワードを設定できる機能を提供する。

### 1.1 目的

- ユーザーがパスワードを忘れた際の自己解決手段を提供
- セキュアなパスワードリセットフローの実装（Laravelの標準機能を活用）
- Web版とモバイル版で統一されたユーザー体験を提供

### 1.2 対象ユーザー

- MyTeacherに登録済みの全ユーザー（大人向け・子ども向け両方）
- パスワードを忘れてログインできないユーザー

---

## 2. 機能要件

### 2.1 パスワードリセットリクエスト機能

#### 2.1.1 Web版（Blade）

**エンドポイント**: `POST /forgot-password`

**画面要素**:
- グラデーション背景（`#F3F3F2` → `#ffffff` → `#e5e7eb`）
- フローティング装飾3つ（半透明円形、blurエフェクト風）
- ロゴアイコン（schoolアイコン + pingアニメーション）
- タイトル「MyTeacher」（グラデーションテキスト: `#59B9C6` → `#9333EA`）
- サブタイトル「パスワードをお忘れですか？」
- グラスモーフィズムカード（`rgba(255, 255, 255, 0.85)`、影付き）
- 説明文「メールアドレスを入力してください。パスワードリセット用のリンクをお送りします。」
- メールアドレス入力フィールド
- 「リセットリンクを送信」ボタン（グラデーション）
- 「ログインへ戻る」リンク

**処理フロー**:
1. ユーザーがログイン画面の「パスワードをお忘れですか？」リンクをクリック
2. パスワードリセット画面（`/forgot-password`）に遷移
3. メールアドレスを入力
4. 「リセットリンクを送信」ボタンをクリック
5. バックエンドがメールアドレスを検証
6. 登録済みメールアドレスの場合、リセットトークンを生成してメール送信
7. 成功メッセージを表示（「パスワードリセット用のリンクをメールで送信しました」）
8. ユーザーはメールからリセットリンクをクリック
9. パスワードリセット画面（`/reset-password/{token}`）で新しいパスワードを設定

**バリデーション**:
- メールアドレス必須
- メールアドレス形式チェック
- 登録済みメールアドレスチェック

**エラーハンドリング**:
- 未登録メールアドレス: 「このメールアドレスは登録されていません」
- レート制限超過: 「しばらく時間をおいてから再度お試しください」
- その他のエラー: 「リクエストに失敗しました」

#### 2.1.2 モバイル版（React Native）

**エンドポイント**: `POST /api/auth/forgot-password`

**画面要素**:
- Web版と同じデザイン（グラデーション背景、フローティング装飾、ロゴアニメーション）
- レスポンシブ対応（`responsive.ts`使用）
- SafeAreaView対応（iOS notch対応）
- KeyboardAvoidingView対応（キーボード表示時の自動スクロール）

**処理フロー**:
1. ユーザーがログイン画面の「パスワードをお忘れですか？」リンクをタップ
2. パスワードリセット画面（`ForgotPasswordScreen`）に遷移
3. メールアドレスを入力
4. 「リセットリンクを送信」ボタンをタップ
5. バックエンドAPIを呼び出し（`authService.forgotPassword()`）
6. 成功時: 緑色の成功メッセージを表示（check-circleアイコン付き）
7. 3秒後に自動的にログイン画面へ遷移
8. エラー時: 赤色のエラーメッセージを表示（error-outlineアイコン付き）

**バリデーション**:
- メールアドレス必須（クライアント側）
- メールアドレス形式チェック（正規表現: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`）
- 登録済みメールアドレスチェック（サーバー側）

**エラーハンドリング**:
- 空のメールアドレス: 「メールアドレスを入力してください」
- 無効な形式: 「有効なメールアドレスを入力してください」
- 404エラー: 「APIエンドポイントが見つかりません。サーバー設定を確認してください。」
- サーバーエラー: バックエンドから返されたエラーメッセージを表示

**UI/UX要件**:
- ローディング中はActivityIndicatorを表示
- ローディング中は入力フィールドとボタンを無効化
- 成功後は送信ボタンを非表示
- メールアドレスフィールドは`email-address`キーボードタイプ
- 自動大文字化を無効化（`autoCapitalize="none"`）
- アクセシビリティラベル設定（`accessibilityLabel="メールアドレス入力"`）

### 2.2 パスワードリセット実行機能

**注**: この機能はWeb版のみで実装（モバイル版は将来的な拡張予定）

**エンドポイント**: `POST /reset-password`

**処理フロー**:
1. ユーザーがメールのリセットリンクをクリック
2. `/reset-password/{token}?email={email}` に遷移
3. 新しいパスワードと確認用パスワードを入力
4. バックエンドがトークンとメールアドレスを検証
5. パスワードをハッシュ化して保存
6. 成功メッセージを表示してログイン画面へリダイレクト

---

## 3. 非機能要件

### 3.1 セキュリティ

- **トークン生成**: Laravelの`Password::sendResetLink()`を使用（標準的な暗号化トークン）
- **トークン有効期限**: 60分（Laravelデフォルト）
- **レート制限**: 60秒に1回（`throttle:6,1`ミドルウェア）
- **メール送信**: AWS SES経由（テスト環境: Sandboxモード、本番: Sandbox削除申請後）
- **HTTPS必須**: 本番環境では必須（リセットリンクのセキュリティ確保）

### 3.2 パフォーマンス

- **レスポンスタイム**: API呼び出しから1秒以内にレスポンス（メール送信は非同期）
- **メール送信**: キュー処理（非同期）でユーザー待機時間を最小化
- **タイムアウト**: モバイルAPIクライアントのタイムアウト: 10秒

### 3.3 可用性

- **エラーハンドリング**: 全てのエラーケースで適切なメッセージを表示
- **フォールバック**: AWS SES障害時はログに記録（管理者に通知）
- **リトライ**: メール送信失敗時は自動リトライ（最大3回）

### 3.4 ユーザビリティ

- **レスポンシブデザイン**: モバイル版は全デバイスサイズに対応（xs: 320px～tablet: 1024px～）
- **アニメーション**: スムーズな画面遷移（フェードイン・フェードアウト）
- **フィードバック**: ローディング状態の視覚的表示
- **アクセシビリティ**: スクリーンリーダー対応（accessibilityLabel設定）

---

## 4. API仕様

### 4.1 パスワードリセットリクエスト（モバイル）

```yaml
POST /api/auth/forgot-password
Content-Type: application/json

Request Body:
{
  "email": "user@example.com"
}

Response (200 OK):
{
  "message": "パスワードリセット用のリンクをメールで送信しました"
}

Response (422 Unprocessable Entity):
{
  "message": "入力内容に誤りがあります",
  "errors": {
    "email": [
      "このメールアドレスは登録されていません"
    ]
  }
}

Response (429 Too Many Requests):
{
  "message": "リクエストが多すぎます。しばらく時間をおいてから再度お試しください"
}
```

### 4.2 パスワードリセットリクエスト（Web）

```yaml
POST /forgot-password
Content-Type: application/x-www-form-urlencoded

Request Body:
email=user@example.com

Response (Redirect):
- Success: Redirect to /forgot-password with status message
- Error: Redirect back with error message
```

---

## 5. データベース設計

### 5.1 既存テーブル活用

Laravelの標準パスワードリセット機能を使用するため、既存テーブルを活用:

**テーブル**: `password_reset_tokens`

| カラム | 型 | 説明 |
|--------|-----|------|
| email | VARCHAR(255) | ユーザーのメールアドレス（主キー） |
| token | VARCHAR(255) | リセットトークン（ハッシュ化） |
| created_at | TIMESTAMP | トークン生成日時 |

**インデックス**:
- PRIMARY KEY: `email`
- INDEX: `created_at`（有効期限チェック用）

---

## 6. メール通知設計

### 6.1 メールテンプレート

**Subject**: 【MyTeacher】パスワードリセットのご案内

**Body**:
```
MyTeacherをご利用いただきありがとうございます。

パスワードリセットのリクエストを受け付けました。
以下のリンクをクリックして、新しいパスワードを設定してください。

[パスワードをリセット]
{{ $actionUrl }}

このリンクは60分間有効です。
パスワードリセットをリクエストしていない場合は、このメールを無視してください。

何かご不明な点がございましたら、サポートまでお問い合わせください。

MyTeacherチーム
```

**カスタマイズ**: `app/Notifications/ResetPasswordNotification.php`（252行）で日本語対応済み

### 6.2 送信設定

- **送信元**: `noreply@myteacher.com`（仮）
- **配信サービス**: AWS SES
- **環境別設定**:
  - テスト環境: Sandboxモード（famicoapp@gmail.com検証済み）
  - 本番環境: Sandbox削除申請後に全メールアドレスへ送信可能

---

## 7. 画面設計

### 7.1 Web版画面仕様

**ファイル**: `resources/views/auth/forgot-password.blade.php`（150行）

**レイアウト**:
- グラデーション背景（全画面）
- フローティング装飾3つ（左上、右中央、左下）
- 中央配置のカード
- ロゴ + タイトル + サブタイトル
- 説明文 + 入力フィールド + ボタン

**CSS**:
- Tailwind CSS 3
- カスタムクラス: `auth-gradient-bg`（グラデーション背景）
- アニメーション: `animate-ping`（ロゴ装飾）
- グラデーションテキスト: `bg-clip-text`

### 7.2 モバイル版画面仕様

**ファイル**: `mobile/src/screens/auth/ForgotPasswordScreen.tsx`（433行）

**コンポーネント構成**:
- SafeAreaView（iOS notch対応）
- KeyboardAvoidingView（キーボード対応）
- LinearGradient（背景）
- ScrollView（スクロール対応）
- View（フローティング装飾3つ）
- Animated.View（pingアニメーション）
- MaskedView + LinearGradient（グラデーションテキスト）
- TextInput（メールアドレス入力）
- TouchableOpacity + LinearGradient（送信ボタン）
- 成功/エラーメッセージ表示

**スタイル**:
- レスポンシブ関数: `getFontSize()`, `getSpacing()`, `getBorderRadius()`, `getShadow()`
- テーマ対応: `useChildTheme()` フック
- デバイスサイズ別スケーリング（xs: 0.8倍～tablet: 1.15倍）

---

## 8. エラーハンドリング

### 8.1 クライアント側エラー（モバイル）

| エラー内容 | 表示メッセージ | UI表示 |
|-----------|---------------|--------|
| メールアドレス未入力 | 「メールアドレスを入力してください」 | 赤背景のエラーカード |
| メールアドレス形式不正 | 「有効なメールアドレスを入力してください」 | 赤背景のエラーカード |
| 404エラー | 「APIエンドポイントが見つかりません。サーバー設定を確認してください。」 | 赤背景のエラーカード |
| ネットワークエラー | 「リクエストに失敗しました。しばらく時間をおいてから再度お試しください」 | 赤背景のエラーカード |

### 8.2 サーバー側エラー

| エラー内容 | HTTPステータス | レスポンス |
|-----------|---------------|-----------|
| 未登録メールアドレス | 422 | `{"message": "...", "errors": {"email": ["このメールアドレスは登録されていません"]}}` |
| レート制限超過 | 429 | `{"message": "リクエストが多すぎます..."}` |
| サーバーエラー | 500 | `{"message": "サーバーエラーが発生しました"}` |

---

## 9. テスト要件

### 9.1 バックエンドテスト

**ファイル**: `tests/Feature/Api/Auth/PasswordResetApiTest.php`

**テストケース**:
1. ✅ 登録済みメールアドレスでリセットリクエストを送信できる
2. ✅ 未登録メールアドレスでエラーになる
3. ✅ メールアドレス必須バリデーション
4. ✅ メールアドレス形式バリデーション
5. ✅ APIリクエストはJSON形式でレスポンスを返す
6. ⏭️ スロットリングテスト（61秒待機が必要なためスキップ）
7. ✅ Web版エンドポイントでもJSON形式リクエストを処理可能

**実行方法**:
```bash
CACHE_STORE=array DB_CONNECTION=sqlite DB_DATABASE=:memory: \
php artisan test tests/Feature/Api/Auth/PasswordResetApiTest.php
```

### 9.2 フロントエンドテスト（モバイル）

**ファイル**: `mobile/src/screens/auth/__tests__/ForgotPasswordScreen.test.tsx`

**テストケース**:
1. ✅ 初期表示（ロゴ、タイトル、フォーム要素）
2. ✅ メールアドレス入力フィールドの動作
3. ✅ バリデーション（空、無効な形式、有効な形式）
4. ✅ リセットリクエスト送信（成功時）
5. ✅ ローディング状態の表示
6. ✅ 入力フィールドの無効化（送信中）
7. ✅ 成功メッセージの表示
8. ✅ 送信ボタンの非表示（成功後）
9. ✅ エラーハンドリング（APIエラー、バリデーションエラー、404エラー）
10. ✅ ナビゲーション（戻るボタン、3秒後の自動遷移）
11. ✅ アクセシビリティ（accessibilityLabel）

**実行方法**:
```bash
cd mobile && npm test -- ForgotPasswordScreen.test.tsx --no-coverage
```

---

## 10. デプロイ・運用

### 10.1 環境変数

```bash
# AWS SES設定
MAIL_MAILER=ses
MAIL_FROM_ADDRESS=noreply@myteacher.com
MAIL_FROM_NAME="MyTeacher"
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...
AWS_DEFAULT_REGION=us-east-1

# アプリケーションURL（リセットリンクに使用）
APP_URL=https://myteacher.com
```

### 10.2 本番環境移行手順

1. AWS SES Sandbox削除申請
   - AWS SESコンソールから申請
   - 送信理由・使用用途を記載
   - 承認まで1-2営業日

2. DNSレコード設定
   - SPFレコード追加
   - DKIMレコード追加（SES提供）
   - DMARCレコード追加

3. 送信テスト
   - テスト環境で動作確認
   - 本番環境で少数ユーザーにテスト送信
   - 全ユーザーへ展開

### 10.3 監視・アラート

- **メール送信失敗**: CloudWatch Logsで監視
- **レート制限超過**: アクセスログで監視
- **エラー発生率**: Sentryでトラッキング

---

## 11. 今後の拡張予定

### 11.1 モバイル版パスワードリセット実行画面

現在はメールリンクからWeb版の`/reset-password/{token}`に遷移する仕様だが、将来的にはモバイルアプリ内でパスワードリセットを完結できるよう実装予定。

**実装内容**:
- `ResetPasswordScreen.tsx`新規作成
- Deep Link対応（`myteacher://reset-password/{token}`）
- 新しいパスワード + 確認用パスワード入力
- API: `POST /api/auth/reset-password`

### 11.2 二要素認証（2FA）との統合

パスワードリセット後に2FAが有効なユーザーは認証コード入力を要求する。

### 11.3 パスワード強度チェック

新しいパスワード設定時に強度チェックを実施（最低8文字、大文字・小文字・数字・記号を含む等）。

---

## 12. 参考資料

- Laravel公式ドキュメント: [Password Reset](https://laravel.com/docs/10.x/passwords)
- AWS SES公式ドキュメント: [Amazon SES](https://docs.aws.amazon.com/ses/)
- React Native公式ドキュメント: [React Native](https://reactnative.dev/)
- Expo公式ドキュメント: [Expo](https://docs.expo.dev/)
